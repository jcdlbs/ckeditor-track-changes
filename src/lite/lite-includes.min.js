!function(e){function t(e,t){var n=typeof e[t];return n==T||!(n!=N||!e[t])||"unknown"==n}function n(e,t){return!(typeof e[t]!=N||!e[t])}function i(e,t){return typeof e[t]!=E}function r(e){return function(t,n){for(var i=n.length;i--;)if(!e(t,n[i]))return!1;return!0}}function o(e){return e&&R(e,b)&&w(e,S)}function a(e){return n(e,"body")?e.body:e.getElementsByTagName("body")[0]}function s(e){n(window,"console")&&t(window.console,"log")&&window.console.log(e)}function d(e,t){t?window.alert(e):s(e)}function c(e){D.initialized=!0,D.supported=!1,d("Rangy is not supported on this page in your browser. Reason: "+e,D.config.alertOnFail)}function l(e){d("Rangy warning: "+e,D.config.alertOnWarn)}function u(e){return e.message||e.description||String(e)}function h(){if(!D.initialized){var e,n=!1,i=!1;t(document,"createRange")&&(e=document.createRange(),R(e,_)&&w(e,y)&&(n=!0));var r=a(document);if(!r||"body"!=r.nodeName.toLowerCase())return void c("No body element found");if(r&&t(r,"createTextRange")&&(e=r.createTextRange(),o(e)&&(i=!0)),!n&&!i)return void c("Neither Range nor TextRange are available");D.initialized=!0,D.features={implementsDomRange:n,implementsTextRange:i};var d,l;for(var h in x)(d=x[h])instanceof g&&d.init(d,D);for(var f=0,m=A.length;m>f;++f)try{A[f](D)}catch(p){l="Rangy init listener threw an exception. Continuing. Detail: "+u(p),s(l)}}}function f(e){e=e||window,h();for(var t=0,n=k.length;n>t;++t)k[t](e)}function g(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function m(e,t,n,i){var r=new g(t,n,function(e){if(!e.initialized){e.initialized=!0;try{i(D,e),e.supported=!0}catch(n){var r="Module '"+t+"' failed to load: "+u(n);s(r)}}});x[t]=r}function p(){}function v(){}var C="function"==typeof e.define&&e.define.amd,N="object",T="function",E="undefined",y=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],_=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],S=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],b=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],R=r(t),O=r(n),w=r(i),x={},D={version:"1.3alpha.20140716",initialized:!1,supported:!0,util:{isHostMethod:t,isHostObject:n,isHostProperty:i,areHostMethods:R,areHostObjects:O,areHostProperties:w,isTextRange:o,getBody:a},features:{},modules:x,config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};D.fail=c,D.warn=l,{}.hasOwnProperty?D.util.extend=function(e,t,n){var i,r;for(var o in t)t.hasOwnProperty(o)&&(i=e[o],r=t[o],n&&null!==i&&"object"==typeof i&&null!==r&&"object"==typeof r&&D.util.extend(i,r,!0),e[o]=r);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e}:c("hasOwnProperty not supported"),function(){var e=document.createElement("div");e.appendChild(document.createElement("span"));var t,n=[].slice;try{1==n.call(e.childNodes,0)[0].nodeType&&(t=function(e){return n.call(e,0)})}catch(i){}t||(t=function(e){for(var t=[],n=0,i=e.length;i>n;++n)t[n]=e[n];return t}),D.util.toArray=t}();var I;t(document,"addEventListener")?I=function(e,t,n){e.addEventListener(t,n,!1)}:t(document,"attachEvent")?I=function(e,t,n){e.attachEvent("on"+t,n)}:c("Document does not have required addEventListener or attachEvent method"),D.util.addListener=I;var A=[];D.init=h,D.addInitListener=function(e){D.initialized?e(D):A.push(e)};var k=[];D.addCreateMissingNativeApiListener=function(e){k.push(e)},D.createMissingNativeApi=f,g.prototype={init:function(){for(var e,t,n=this.dependencies||[],i=0,r=n.length;r>i;++i){if(t=n[i],e=x[t],!(e&&e instanceof g))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+e)},warn:function(e){D.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){D.warn("DEPRECATED: "+e+" in module "+this.name+"is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},D.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]),m(!1,e,n,t)},D.createCoreModule=function(e,t,n){m(!0,e,t,n)},D.RangePrototype=p,D.rangePrototype=new p,D.selectionPrototype=new v;var B=!1,M=function(){B||(B=!0,D.initialized||h())};return typeof window==E?void c("No window found"):typeof document==E?void c("No document found"):(t(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",M,!1),I(window,"load",M),C&&!function(e){e(function(){return D.amd=!0,D})}(e.define),void(e.rangy=D))}(this),rangy.createCoreModule("DomUtil",[],function(e,t){function n(e){var t;return typeof e.namespaceURI==x||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function i(e){var t=e.parentNode;return 1==t.nodeType?t:null}function r(e){for(var t=0;e=e.previousSibling;)++t;return t}function o(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function a(e,t){var n,i=[];for(n=e;n;n=n.parentNode)i.push(n);for(n=t;n;n=n.parentNode)if(k(i,n))return n;return null}function s(e,t,n){for(var i=n?t:t.parentNode;i;){if(i===e)return!0;i=i.parentNode}return!1}function d(e,t){return s(e,t,!0)}function c(e,t,n){for(var i,r=n?e:e.parentNode;r;){if(i=r.parentNode,i===t)return r;r=i}return null}function l(e){var t=e.nodeType;return 3==t||4==t||8==t}function u(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function h(e,t){var n=t.nextSibling,i=t.parentNode;return n?i.insertBefore(e,n):i.appendChild(e),e}function f(e,t,n){var i=e.cloneNode(!1);if(i.deleteData(0,t),e.deleteData(t,e.length-t),h(i,e),n)for(var o,a=0;o=n[a++];)o.node==e&&o.offset>t?(o.node=i,o.offset-=t):o.node==e.parentNode&&o.offset>r(e)&&++o.offset;return i}function g(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=x)return e.ownerDocument;if(typeof e.document!=x)return e.document;if(e.parentNode)return g(e.parentNode);throw t.createError("getDocument: no document found for node")}function m(e){var n=g(e);if(typeof n.defaultView!=x)return n.defaultView;if(typeof n.parentWindow!=x)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function p(e){if(typeof e.contentDocument!=x)return e.contentDocument;if(typeof e.contentWindow!=x)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function v(e){if(typeof e.contentWindow!=x)return e.contentWindow;if(typeof e.contentDocument!=x)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function C(e){return e&&D.isHostMethod(e,"setTimeout")&&D.isHostObject(e,"document")}function N(e,t,n){var i;if(e?D.isHostProperty(e,"nodeType")?i=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?p(e):g(e):C(e)&&(i=e.document):i=document,!i)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return i}function T(e){for(var t;t=e.parentNode;)e=t;return e}function E(e,n,i,o){var s,d,l,u,h;if(e==i)return n===o?0:o>n?-1:1;if(s=c(i,e,!0))return n<=r(s)?-1:1;if(s=c(e,i,!0))return r(s)<o?-1:1;if(d=a(e,i),!d)throw new Error("comparePoints error: nodes have no common ancestor");if(l=e===d?d:c(e,d,!0),u=i===d?d:c(i,d,!0),l===u)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(h=d.firstChild;h;){if(h===l)return-1;if(h===u)return 1;h=h.nextSibling}}function y(e){var t;try{return t=e.parentNode,!1}catch(n){return!0}}function _(e){if(!e)return"[No node]";if(B&&y(e))return"[Broken node]";if(l(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+r(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function S(e){for(var t,n=g(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function b(e){this.root=e,this._next=e}function R(e){return new b(e)}function O(e,t){this.node=e,this.offset=t}function w(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var x="undefined",D=e.util;D.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),D.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var I=document.createElement("div");D.areHostMethods(I,["insertBefore","appendChild","cloneNode"]||!D.areHostObjects(I,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),D.isHostProperty(I,"innerHTML")||t.fail("Element is missing innerHTML property");var A=document.createTextNode("test");D.areHostMethods(A,["splitText","deleteData","insertData","appendData","cloneNode"]||!D.areHostObjects(I,["previousSibling","nextSibling","childNodes","parentNode"])||!D.areHostProperties(A,["data"]))||t.fail("Incomplete Text Node implementation");var k=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},B=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br>",B=y(n),e.features.crashyTextNodes=B}();var M;typeof window.getComputedStyle!=x?M=function(e,t){return m(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=x?M=function(e,t){return e.currentStyle[t]}:t.fail("No means of obtaining computed style properties found"),b.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},O.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+_(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},w.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},w.prototype.toString=function(){return this.message},e.dom={arrayContains:k,isHtmlNamespace:n,parentElement:i,getNodeIndex:r,getNodeLength:o,getCommonAncestor:a,isAncestorOf:s,isOrIsAncestorOf:d,getClosestAncestorIn:c,isCharacterDataNode:l,isTextOrCommentNode:u,insertAfter:h,splitDataNode:f,getDocument:g,getWindow:m,getIframeWindow:v,getIframeDocument:p,getBody:D.getBody,isWindow:C,getContentDocument:N,getRootContainer:T,comparePoints:E,isBrokenNode:y,inspectNode:_,getComputedStyleProperty:M,fragmentFromNodeChildren:S,createIterator:R,DomPosition:O},e.DOMException=w}),rangy.createCoreModule("DomRange",["DomUtil"],function(e){function t(e,t){return 3!=e.nodeType&&(H(e,t.startContainer)||H(e,t.endContainer))}function n(e){return e.document||Q(e.startContainer)}function i(e){return new M(e.parentNode,j(e))}function r(e){return new M(e.parentNode,j(e)+1)}function o(e,t,n){var i=11==e.nodeType?e.firstChild:e;return L(t)?n==t.length?k.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:U(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),i}function a(e,t,i){if(S(e),S(t),n(t)!=n(e))throw new P("WRONG_DOCUMENT_ERR");var r=W(e.startContainer,e.startOffset,t.endContainer,t.endOffset),o=W(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return i?0>=r&&o>=0:0>r&&o>0}function s(e){for(var t,i,r,o=n(e.range).createDocumentFragment();i=e.next();){if(t=e.isPartiallySelectedSubtree(),i=i.cloneNode(!t),t&&(r=e.getSubtreeIterator(),i.appendChild(s(r)),r.detach()),10==i.nodeType)throw new P("HIERARCHY_REQUEST_ERR");o.appendChild(i)}return o}function d(e,t,n){var i,r;n=n||{stop:!1};for(var o,a;o=e.next();)if(e.isPartiallySelectedSubtree()){if(t(o)===!1)return void(n.stop=!0);if(a=e.getSubtreeIterator(),d(a,t,n),a.detach(),n.stop)return}else for(i=k.createIterator(o);r=i.next();)if(t(r)===!1)return void(n.stop=!0)}function c(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),c(t),t.detach()):e.remove()}function l(e){for(var t,i,r=n(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),i=e.getSubtreeIterator(),t.appendChild(l(i)),i.detach()):e.remove(),10==t.nodeType)throw new P("HIERARCHY_REQUEST_ERR");r.appendChild(t)}return r}function u(e,t,n){var i,r=!(!t||!t.length),o=!!n;r&&(i=new RegExp("^("+t.join("|")+")$"));var a=[];return d(new f(e,!1),function(t){if(!(r&&!i.test(t.nodeType)||o&&!n(t))){var s=e.startContainer;if(t!=s||!L(s)||e.startOffset!=s.length){var d=e.endContainer;t==d&&L(d)&&0==e.endOffset||a.push(t)}}}),a}function h(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+k.inspectNode(e.startContainer)+":"+e.startOffset+", "+k.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function f(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&L(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||L(this.sc)?F(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||L(this.ec)?F(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function g(e){return function(t,n){for(var i,r=n?t:t.parentNode;r;){if(i=r.nodeType,X(e,i))return r;r=r.parentNode}return null}}function m(e,t){if(tt(e,t))throw new P("INVALID_NODE_TYPE_ERR")}function p(e,t){if(!X(t,e.nodeType))throw new P("INVALID_NODE_TYPE_ERR")}function v(e,t){if(0>t||t>(L(e)?e.length:e.childNodes.length))throw new P("INDEX_SIZE_ERR")}function C(e,t){if(Z(e,!0)!==Z(t,!0))throw new P("WRONG_DOCUMENT_ERR")}function N(e){if(et(e,!0))throw new P("NO_MODIFICATION_ALLOWED_ERR")}function T(e,t){if(!e)throw new P(t)}function E(e){return z&&k.isBrokenNode(e)||!X(G,e.nodeType)&&!Z(e,!0)}function y(e,t){return t<=(L(e)?e.length:e.childNodes.length)}function _(e){return!!e.startContainer&&!!e.endContainer&&!E(e.startContainer)&&!E(e.endContainer)&&y(e.startContainer,e.startOffset)&&y(e.endContainer,e.endOffset)}function S(e){if(!_(e))throw new Error("Range error: Range is no longer valid after DOM mutation ("+e.inspect()+")")}function b(e,t){S(e);var n=e.startContainer,i=e.startOffset,r=e.endContainer,o=e.endOffset,a=n===r;L(r)&&o>0&&o<r.length&&U(r,o,t),L(n)&&i>0&&i<n.length&&(n=U(n,i,t),a?(o-=i,r=n):r==n.parentNode&&o>=j(n)&&o++,i=0),e.setStartAndEnd(n,i,r,o)}function R(e){e.START_TO_START=st,e.START_TO_END=dt,e.END_TO_END=ct,e.END_TO_START=lt,e.NODE_BEFORE=ut,e.NODE_AFTER=ht,e.NODE_BEFORE_AND_AFTER=ft,e.NODE_INSIDE=gt}function O(e){R(e),R(e.prototype)}function w(e,t){return function(){S(this);var n,i,o=this.startContainer,a=this.startOffset,s=this.commonAncestorContainer,c=new f(this,!0);o!==s&&(n=F(o,s,!0),i=r(n),o=i.node,a=i.offset),d(c,N),c.reset();var l=e(c);return c.detach(),t(this,o,a,o,a),l}}function x(n,o){function a(e,t){return function(n){p(n,q),p(K(n),G);var o=(e?i:r)(n);(t?s:d)(this,o.node,o.offset)}}function s(e,t,n){var i=e.endContainer,r=e.endOffset;(t!==e.startContainer||n!==e.startOffset)&&((K(t)!=K(i)||1==W(t,n,i,r))&&(i=t,r=n),o(e,t,n,i,r))}function d(e,t,n){var i=e.startContainer,r=e.startOffset;(t!==e.endContainer||n!==e.endOffset)&&((K(t)!=K(i)||-1==W(t,n,i,r))&&(i=t,r=n),o(e,i,r,t,n))}var u=function(){};u.prototype=e.rangePrototype,n.prototype=new u,B.extend(n.prototype,{setStart:function(e,t){m(e,!0),v(e,t),s(this,e,t)},setEnd:function(e,t){m(e,!0),v(e,t),d(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],i=t,r=n;switch(e.length){case 3:r=e[2];break;case 4:i=e[2],r=e[3]}o(this,t,n,i,r)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:a(!0,!0),setStartAfter:a(!1,!0),setEndBefore:a(!0,!1),setEndAfter:a(!1,!1),collapse:function(e){S(this),e?o(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):o(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){m(e,!0),o(this,e,0,e,V(e))},selectNode:function(e){m(e,!1),p(e,q);var t=i(e),n=r(e);o(this,t.node,t.offset,n.node,n.offset)},extractContents:w(l,o),deleteContents:w(c,o),canSurroundContents:function(){S(this),N(this.startContainer),N(this.endContainer);var e=new f(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},splitBoundaries:function(){b(this)},splitBoundariesPreservingPositions:function(e){b(this,e)},normalizeBoundaries:function(){S(this);var e=this.startContainer,t=this.startOffset,n=this.endContainer,i=this.endOffset,r=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(n=e,i=e.length,e.appendData(t.data),t.parentNode.removeChild(t))},a=function(r){var o=r.previousSibling;if(o&&o.nodeType==r.nodeType){e=r;var a=r.length;if(t=o.length,r.insertData(0,o.data),o.parentNode.removeChild(o),e==n)i+=t,n=e;else if(n==r.parentNode){var s=j(r);i==s?(n=r,i=a):i>s&&i--}}},s=!0;if(L(n))n.length==i&&r(n);else{if(i>0){var d=n.childNodes[i-1];d&&L(d)&&r(d)}s=!this.collapsed}if(s){if(L(e))0==t&&a(e);else if(t<e.childNodes.length){var c=e.childNodes[t];c&&L(c)&&a(c)}}else e=n,t=i;o(this,e,t,n,i)},collapseToPoint:function(e,t){m(e,!0),v(e,t),this.setStartAndEnd(e,t)}}),O(n)}function D(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:k.getCommonAncestor(e.startContainer,e.endContainer)}function I(e,t,n,i,r){e.startContainer=t,e.startOffset=n,e.endContainer=i,e.endOffset=r,e.document=k.getDocument(t),D(e)}function A(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,D(this)}var k=e.dom,B=e.util,M=k.DomPosition,P=e.DOMException,L=k.isCharacterDataNode,j=k.getNodeIndex,H=k.isOrIsAncestorOf,Q=k.getDocument,W=k.comparePoints,U=k.splitDataNode,F=k.getClosestAncestorIn,V=k.getNodeLength,X=k.arrayContains,K=k.getRootContainer,z=e.features.crashyTextNodes;f.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,L(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!L(n)||n!==this.sc&&n!==this.ec?n.parentNode&&n.parentNode.removeChild(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return t(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new A(n(this.range));var t=this._current,i=t,r=0,o=t,a=V(t);H(t,this.sc)&&(i=this.sc,r=this.so),H(t,this.ec)&&(o=this.ec,a=this.eo),I(e,i,r,o,a)}return new f(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var q=[1,3,4,5,7,8,10],G=[2,9,11],Y=[5,6,10,12],$=[1,3,4,5,7,8,10,11],J=[1,3,4,5,7,8],Z=g([9,11]),et=g(Y),tt=g([6,10,12]),nt=document.createElement("style"),it=!1;try{nt.innerHTML="<b>x</b>",it=3==nt.firstChild.nodeType}catch(rt){}e.features.htmlParsingConforms=it;var ot=it?function(e){var t=this.startContainer,n=Q(t);if(!t)throw new P("INVALID_STATE_ERR");var i=null;return 1==t.nodeType?i=t:L(t)&&(i=k.parentElement(t)),i=null===i||"HTML"==i.nodeName&&k.isHtmlNamespace(Q(i).documentElement)&&k.isHtmlNamespace(i)?n.createElement("body"):i.cloneNode(!1),i.innerHTML=e,k.fragmentFromNodeChildren(i)}:function(e){var t=n(this),i=t.createElement("body");return i.innerHTML=e,k.fragmentFromNodeChildren(i)},at=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],st=0,dt=1,ct=2,lt=3,ut=0,ht=1,ft=2,gt=3;B.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){S(this),C(this.startContainer,t.startContainer);var n,i,r,o,a=e==lt||e==st?"start":"end",s=e==dt||e==st?"start":"end";return n=this[a+"Container"],i=this[a+"Offset"],r=t[s+"Container"],o=t[s+"Offset"],W(n,i,r,o)},insertNode:function(e){if(S(this),p(e,$),N(this.startContainer),H(e,this.startContainer))throw new P("HIERARCHY_REQUEST_ERR");var t=o(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){S(this);var e,t;if(this.collapsed)return n(this).createDocumentFragment();if(this.startContainer===this.endContainer&&L(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=n(this).createDocumentFragment(),t.appendChild(e),t;var i=new f(this,!0);return e=s(i),i.detach(),e},canSurroundContents:function(){S(this),N(this.startContainer),N(this.endContainer);var e=new f(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},surroundContents:function(e){if(p(e,J),!this.canSurroundContents())throw new P("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);o(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){S(this);for(var e,t=new A(n(this)),i=at.length;i--;)e=at[i],t[e]=this[e];return t},toString:function(){S(this);var e=this.startContainer;if(e===this.endContainer&&L(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new f(this,!0);return d(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){S(this);var t=e.parentNode,n=j(e);if(!t)throw new P("NOT_FOUND_ERR");var i=this.comparePoint(t,n),r=this.comparePoint(t,n+1);return 0>i?r>0?ft:ut:r>0?ht:gt},comparePoint:function(e,t){return S(this),T(e,"HIERARCHY_REQUEST_ERR"),C(e,this.startContainer),W(e,t,this.startContainer,this.startOffset)<0?-1:W(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ot,toHtml:function(){S(this);var e=this.commonAncestorContainer.parentNode.cloneNode(!1);return e.appendChild(this.cloneContents()),e.innerHTML},intersectsNode:function(e,t){if(S(this),T(e,"NOT_FOUND_ERR"),Q(e)!==n(this))return!1;var i=e.parentNode,r=j(e);T(i,"NOT_FOUND_ERR");var o=W(i,r,this.endContainer,this.endOffset),a=W(i,r+1,this.startContainer,this.startOffset);return t?0>=o&&a>=0:0>o&&a>0},isPointInRange:function(e,t){return S(this),T(e,"HIERARCHY_REQUEST_ERR"),C(e,this.startContainer),W(e,t,this.startContainer,this.startOffset)>=0&&W(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return a(this,e,!1)},intersectsOrTouchesRange:function(e){return a(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=W(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=W(this.endContainer,this.endOffset,e.endContainer,e.endOffset),i=this.cloneRange();return-1==t&&i.setStart(e.startContainer,e.startOffset),1==n&&i.setEnd(e.endContainer,e.endOffset),i}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==W(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==W(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new P("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==gt},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,V(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var i=n.pop();return t.setEnd(i,i.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return S(this),u(this,e,t)},getDocument:function(){return n(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var i=n(this),r=e.createRange(i);t=t||k.getBody(i),r.selectNodeContents(t);var o=this.intersection(r),a=0,s=0;return o&&(r.setEnd(o.startContainer,o.startOffset),a=r.toString().length,s=a+o.toString().length),{start:a,end:s,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var i,r,o,a,s=[t],d=!1,c=!1;!c&&(i=s.pop());)if(3==i.nodeType)r=n+i.length,!d&&e.start>=n&&e.start<=r&&(this.setStart(i,e.start-n),d=!0),d&&e.end>=n&&e.end<=r&&(this.setEnd(i,e.end-n),c=!0),n=r;else for(a=i.childNodes,o=a.length;o--;)s.push(a[o])},getName:function(){return"DomRange"},equals:function(e){return A.rangesEqual(this,e)},isValid:function(){return _(this)},inspect:function(){return h(this)},detach:function(){}}),x(A,I),B.extend(A,{rangeProperties:at,RangeIterator:f,copyComparisonConstants:O,createPrototypeRange:x,inspect:h,getRangeDocument:n,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=A}),rangy.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,i,r=e.dom,o=e.util,a=r.DomPosition,s=e.DomRange,d=r.getBody,c=r.getContentDocument,l=r.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function i(e){for(var t,n=h.length;n--;)t=h[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,i,r){var o=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==i||e.endOffset!=r,s=!e.equals(e.nativeRange);(o||a||s)&&(e.setEnd(i,r),e.setStart(t,n))}var l,u,h=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,i(this)},s.createPrototypeRange(n,a),l=n.prototype,l.selectNode=function(e){this.nativeRange.selectNode(e),i(this)},l.cloneContents=function(){return this.nativeRange.cloneContents()},l.surroundContents=function(e){this.nativeRange.surroundContents(e),i(this)},l.collapse=function(e){this.nativeRange.collapse(e),i(this)},l.cloneRange=function(){return new n(this.nativeRange.cloneRange())},l.refresh=function(){i(this)},l.toString=function(){return this.nativeRange.toString()};var f=document.createTextNode("test");d(document).appendChild(f);var g=document.createRange();g.setStart(f,0),g.setEnd(f,0);try{g.setStart(f,1),l.setStart=function(e,t){this.nativeRange.setStart(e,t),i(this)},l.setEnd=function(e,t){this.nativeRange.setEnd(e,t),i(this)},u=function(e){return function(t){this.nativeRange[e](t),i(this)}}}catch(m){l.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}i(this)},l.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}i(this)},u=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(r){this.nativeRange[t](n),this.nativeRange[e](n)}i(this)}}}l.setStartBefore=u("setStartBefore","setEndBefore"),l.setStartAfter=u("setStartAfter","setEndAfter"),l.setEndBefore=u("setEndBefore","setStartBefore"),l.setEndAfter=u("setEndAfter","setStartAfter"),l.selectNodeContents=function(e){this.setStartAndEnd(e,0,r.getNodeLength(e))},g.selectNodeContents(f),g.setEnd(f,3);var p=document.createRange();p.selectNodeContents(f),p.setEnd(f,4),p.setStart(f,2),l.compareBoundaryPoints=-1==g.compareBoundaryPoints(g.START_TO_END,p)&&1==g.compareBoundaryPoints(g.END_TO_START,p)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var v=document.createElement("div");v.innerHTML="123";var C=v.firstChild,N=d(document);N.appendChild(v),g.setStart(C,1),g.setEnd(C,2),g.deleteContents(),"13"==C.data&&(l.deleteContents=function(){this.nativeRange.deleteContents(),i(this)},l.extractContents=function(){var e=this.nativeRange.extractContents();return i(this),e}),N.removeChild(v),N=null,o.isHostMethod(g,"createContextualFragment")&&(l.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),d(document).removeChild(f),l.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var u=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var i=n.parentElement();n=e.duplicate(),n.collapse(!1);var o=n.parentElement(),a=i==o?i:r.getCommonAncestor(i,o);return a==t?a:r.getCommonAncestor(t,a)},h=function(e){return 0==e.compareEndPoints("StartToEnd",e)},f=function(e,t,n,i,o){var s=e.duplicate();s.collapse(n);var d=s.parentElement();if(r.isOrIsAncestorOf(t,d)||(d=t),!d.canHaveHTML){var c=new a(d.parentNode,r.getNodeIndex(d));return{boundaryPosition:c,nodeInfo:{nodeIndex:c.offset,containerElement:c.node}}}var u=r.getDocument(d).createElement("span");u.parentNode&&u.parentNode.removeChild(u);for(var h,f,g,m,p,v=n?"StartToStart":"StartToEnd",C=o&&o.containerElement==d?o.nodeIndex:0,N=d.childNodes.length,T=N,E=T;;){if(E==N?d.appendChild(u):d.insertBefore(u,d.childNodes[E]),s.moveToElementText(u),h=s.compareEndPoints(v,e),0==h||C==T)break;if(-1==h){if(T==C+1)break;C=E}else T=T==C+1?C:E;E=Math.floor((C+T)/2),d.removeChild(u)}if(p=u.nextSibling,-1==h&&p&&l(p)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var y;if(/[\r\n]/.test(p.data)){var _=s.duplicate(),S=_.text.replace(/\r\n/g,"\r").length;for(y=_.moveStart("character",S);-1==(h=_.compareEndPoints("StartToEnd",_));)y++,_.moveStart("character",1)}else y=s.text.length;m=new a(p,y)}else f=(i||!n)&&u.previousSibling,g=(i||n)&&u.nextSibling,m=g&&l(g)?new a(g,0):f&&l(f)?new a(f,f.data.length):new a(d,r.getNodeIndex(u));return u.parentNode.removeChild(u),{boundaryPosition:m,nodeInfo:{nodeIndex:E,containerElement:d}}},g=function(e,t){var n,i,o,a,s=e.offset,c=r.getDocument(e.node),u=d(c).createTextRange(),h=l(e.node);return h?(n=e.node,i=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,i=e.node),o=c.createElement("span"),o.innerHTML="&#feff;",n?i.insertBefore(o,n):i.appendChild(o),u.moveToElementText(o),u.collapse(!t),i.removeChild(o),h&&u[t?"moveStart":"moveEnd"]("character",s),u};if(i=function(e){this.textRange=e,this.refresh()},i.prototype=new s(document),i.prototype.refresh=function(){var e,t,n,i=u(this.textRange);h(this.textRange)?t=e=f(this.textRange,i,!0,!0).boundaryPosition:(n=f(this.textRange,i,!0,!1),e=n.boundaryPosition,t=f(this.textRange,i,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},i.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(i),i.rangeToTextRange=function(e){if(e.collapsed)return g(new a(e.startContainer,e.startOffset),!0);var t=g(new a(e.startContainer,e.startOffset),!0),n=g(new a(e.endContainer,e.endOffset),!1),i=d(s.getRangeDocument(e)).createTextRange();return i.setEndPoint("StartToStart",t),i.setEndPoint("EndToEnd",n),i},e.WrappedTextRange=i,!e.features.implementsDomRange||e.config.preferTextRange){var m=function(){return this}();"undefined"==typeof m.Range&&(m.Range=i),e.createNativeRange=function(e){return e=c(e,t,"createNativeRange"),d(e).createTextRange()
},e.WrappedRange=i}}e.createRange=function(n){return n=c(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=c(e,t,"createRangyRange"),new s(e)},e.createIframeRange=function(n){return t.deprecationNotice("createIframeRange()","createRange(iframeEl)"),e.createRange(n)},e.createIframeRangyRange=function(n){return t.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),e.createRangyRange(n)},e.addCreateMissingNativeApiListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),rangy.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function i(e,n){if(e){if(w.isWindow(e))return e;if(e instanceof v)return e.win;var i=w.getContentDocument(e,t,n);return w.getWindow(i)}return window}function r(e){return i(e,"getWinSelection").getSelection()}function o(e){return i(e,"getDocSelection").document.selection}function a(e){var t=!1;return e.anchorNode&&(t=1==w.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function s(e,t,n){var i=n?"end":"start",r=n?"start":"end";e.anchorNode=t[i+"Container"],e.anchorOffset=t[i+"Offset"],e.focusNode=t[r+"Container"],e.focusOffset=t[r+"Offset"]}function d(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function c(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function l(t){var n;return t instanceof I?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof A?n=t.nativeRange:M.implementsDomRange&&t instanceof w.getWindow(t.startContainer).Range&&(n=t),n}function u(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!w.isAncestorOf(e[0],e[t]))return!1;return!0}function h(e){var n=e.getNodes();if(!u(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function f(e){return!!e&&"undefined"!=typeof e.text}function g(e,t){var n=new A(t);e._ranges=[n],s(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function m(t){if(t._ranges.length=0,"None"==t.docSelection.type)c(t);else{var n=t.docSelection.createRange();if(f(n))g(t,n);else{t.rangeCount=n.length;for(var i,r=L(n.item(0)),o=0;o<t.rangeCount;++o)i=e.createRange(r),i.selectNode(n.item(o)),t._ranges.push(i);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,s(t,t._ranges[t.rangeCount-1],!1)}}}function p(e,n){for(var i=e.docSelection.createRange(),r=h(n),o=L(i.item(0)),a=j(o).createControlRange(),s=0,d=i.length;d>s;++s)a.add(i.item(s));try{a.add(r)}catch(c){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),m(e)}function v(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function C(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function N(e,t){for(var n,i,r=tt.length;r--;)if(n=tt[r],i=n.selection,"deleteAll"==t)C(i);else if(n.win==e)return"delete"==t?(tt.splice(r,1),!0):i;return"deleteAll"==t&&(tt.length=0),null}function T(e,n){for(var i,r=L(n[0].startContainer),o=j(r).createControlRange(),a=0,s=n.length;s>a;++a){i=h(n[a]);try{o.add(i)}catch(d){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),m(e)}function E(e,t){if(e.win.document!=L(t))throw new k("WRONG_DOCUMENT_ERR")}function y(t){return function(n,i){var r;this.rangeCount?(r=this.getRangeAt(0),r["set"+(t?"Start":"End")](n,i)):(r=e.createRange(this.win.document),r.setStartAndEnd(n,i)),this.setSingleRange(r,this.isBackward())}}function _(e){var t=[],n=new B(e.anchorNode,e.anchorOffset),i=new B(e.focusNode,e.focusOffset),r="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var o=0,a=e.rangeCount;a>o;++o)t[o]=I.inspect(e.getRangeAt(o));return"["+r+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+i.inspect()+"]"}e.config.checkSelectionRanges=!0;var S,b,R="boolean",O="number",w=e.dom,x=e.util,D=x.isHostMethod,I=e.DomRange,A=e.WrappedRange,k=e.DOMException,B=w.DomPosition,M=e.features,P="Control",L=w.getDocument,j=w.getBody,H=I.rangesEqual,Q=D(window,"getSelection"),W=x.isHostObject(document,"selection");M.implementsWinGetSelection=Q,M.implementsDocSelection=W;var U=W&&(!Q||e.config.preferTextRange);U?(S=o,e.isSelectionValid=function(e){var t=i(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||L(n.createRange().parentElement())==t}):Q?(S=r,e.isSelectionValid=function(){return!0}):t.fail("Neither document.selection or window.getSelection() detected."),e.getNativeSelection=S;var F=S(),V=e.createNativeRange(document),X=j(document),K=x.areHostProperties(F,["anchorNode","focusNode","anchorOffset","focusOffset"]);M.selectionHasAnchorAndFocus=K;var z=D(F,"extend");M.selectionHasExtend=z;var q=typeof F.rangeCount==O;M.selectionHasRangeCount=q;var G=!1,Y=!0,$=z?function(t,n){var i=I.getRangeDocument(n),r=e.createRange(i);r.collapseToPoint(n.endContainer,n.endOffset),t.addRange(l(r)),t.extend(n.startContainer,n.startOffset)}:null;x.areHostMethods(F,["addRange","getRangeAt","removeAllRanges"])&&typeof F.rangeCount==O&&M.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,i=n>1,r=[],o=a(t),s=0;n>s;++s)r[s]=t.getRangeAt(s);var d=j(document),c=d.appendChild(document.createElement("div"));c.contentEditable="false";var l=c.appendChild(document.createTextNode("   ")),u=document.createRange();if(u.setStart(l,1),u.collapse(!0),t.addRange(u),Y=1==t.rangeCount,t.removeAllRanges(),!i){var h=u.cloneRange();u.setStart(l,0),h.setEnd(l,3),h.setStart(l,2),t.addRange(u),t.addRange(h),G=2==t.rangeCount,h.detach()}for(d.removeChild(c),t.removeAllRanges(),s=0;n>s;++s)0==s&&o?$?$(t,r[s]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(r[s])):t.addRange(r[s])}}(),M.selectionSupportsMultipleRanges=G,M.collapsedNonEditableSelectionsSupported=Y;var J,Z=!1;X&&D(X,"createControlRange")&&(J=X.createControlRange(),x.areHostProperties(J,["item","add"])&&(Z=!0)),M.implementsControlRange=Z,b=K?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var et;D(F,"getRangeAt")?et=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:K&&(et=function(t){var n=L(t.anchorNode),i=e.createRange(n);return i.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),i.collapsed!==this.isCollapsed&&i.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),i}),v.prototype=e.selectionPrototype;var tt=[],nt=function(e){if(e&&e instanceof v)return e.refresh(),e;e=i(e,"getNativeSelection");var t=N(e),n=S(e),r=W?o(e):null;return t?(t.nativeSelection=n,t.docSelection=r,t.refresh()):(t=new v(n,r,e),tt.push({win:e,selection:t})),t};e.getSelection=nt,e.getIframeSelection=function(n){return t.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),e.getSelection(w.getIframeWindow(n))};var it=v.prototype;if(!U&&K&&x.areHostMethods(F,["removeAllRanges","addRange"])){it.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),c(this)};var rt=function(e,t){$(e.nativeSelection,t),e.refresh()};it.addRange=q?function(t,i){if(Z&&W&&this.docSelection.type==P)p(this,t);else if(n(i)&&z)rt(this,t);else{var r;if(G?r=this.rangeCount:(this.removeAllRanges(),r=0),this.nativeSelection.addRange(l(t).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==r+1){if(e.config.checkSelectionRanges){var o=et(this.nativeSelection,this.rangeCount-1);o&&!H(o,t)&&(t=new A(o))}this._ranges[this.rangeCount-1]=t,s(this,t,st(this.nativeSelection)),this.isCollapsed=b(this)}else this.refresh()}}:function(e,t){n(t)&&z?rt(this,e):(this.nativeSelection.addRange(l(e)),this.refresh())},it.setRanges=function(e){if(Z&&e.length>1)T(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(D(F,"empty")&&D(V,"select")&&Z&&U))return t.fail("No means of selecting a Range or TextRange was found"),!1;it.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=L(this.anchorNode);else if(this.docSelection.type==P){var t=this.docSelection.createRange();t.length&&(e=L(t.item(0)))}if(e){var n=j(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(i){}c(this)},it.addRange=function(t){this.docSelection.type==P?p(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,s(this,t,!1))},it.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?T(this,e):t&&this.addRange(e[0])}}it.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new k("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var ot;if(U)ot=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=j(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==P?m(t):f(n)?g(t,n):c(t)};else if(D(F,"getRangeAt")&&typeof F.rangeCount==O)ot=function(t){if(Z&&W&&t.docSelection.type==P)m(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,i=t.rangeCount;i>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));s(t,t._ranges[t.rangeCount-1],st(t.nativeSelection)),t.isCollapsed=b(t)}else c(t)};else{if(!K||typeof F.isCollapsed!=R||typeof V.collapsed!=R||!M.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;ot=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=et(n,0),e._ranges=[t],e.rangeCount=1,d(e),e.isCollapsed=b(e)):c(e)}}it.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,i=this.anchorOffset;if(ot(this),e){var r=t.length;if(r!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=i)return!0;for(;r--;)if(!H(t[r],this._ranges[r]))return!0;return!1}};var at=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var i=0,r=n.length;r>i;++i)H(t,n[i])||e.addRange(n[i]);e.rangeCount||c(e)};it.removeRange=Z?function(e){if(this.docSelection.type==P){for(var t,n=this.docSelection.createRange(),i=h(e),r=L(n.item(0)),o=j(r).createControlRange(),a=!1,s=0,d=n.length;d>s;++s)t=n.item(s),t!==i||a?o.add(n.item(s)):a=!0;o.select(),m(this)}else at(this,e)}:function(e){at(this,e)};var st;!U&&K&&M.implementsDomRange?(st=a,it.isBackward=function(){return st(this)}):st=it.isBackward=function(){return!1},it.isBackwards=it.isBackward,it.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},it.collapse=function(t,n){E(this,t);var i=e.createRange(t);i.collapseToPoint(t,n),this.setSingleRange(i),this.isCollapsed=!0},it.collapseToStart=function(){if(!this.rangeCount)throw new k("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},it.collapseToEnd=function(){if(!this.rangeCount)throw new k("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},it.selectAllChildren=function(t){E(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},it.deleteFromDocument=function(){if(Z&&W&&this.docSelection.type==P){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),e.parentNode.removeChild(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var i=0,r=n.length;r>i;++i)n[i].deleteContents();this.addRange(n[r-1])}}},it.eachRange=function(e,t){for(var n=0,i=this._ranges.length;i>n;++n)if(e(this.getRangeAt(n)))return t},it.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},it.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},it.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(i){n.push(i[e].apply(i,t))}),n},it.setStart=y(!0),it.setEnd=y(!1),e.rangePrototype.select=function(e){nt(this.getDocument()).setSingleRange(this,e)},it.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},it.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)},it.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},it.moveToBookmark=function(t){for(var n,i,r=[],o=0;n=t.rangeBookmarks[o++];)i=e.createRange(this.win),i.moveToBookmark(n),r.push(i);t.backward?this.setSingleRange(r[0],"backward"):this.setRanges(r)},it.toHtml=function(){return this.callMethodOnEachRange("toHtml").join("")},it.getName=function(){return"WrappedSelection"},it.inspect=function(){return _(this)},it.detach=function(){N(this.win,"delete"),C(this)},v.detachAll=function(){N(null,"deleteAll")},v.inspect=_,v.isDirectionBackward=n,e.Selection=v,e.selectionPrototype=it,e.addCreateMissingNativeApiListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return nt(e)}),e=null})}),function(){function e(e){return e}function t(e,t){if(!e)return!1;var n=e.nodeType;return ice.dom.TEXT_NODE==n?t&&e.nodeValue&&t>=e.nodeValue.length-1:ice.dom.ELEMENT_NODE==n?e.childNodes&&e.childNodes.length&&t>=e.childNodes.length:!1}function n(e,t){if(!e||!t||e.collapsed)return e;var n;try{for(;(n=e.endContainer)&&n!=t&&0==e.endOffset&&!e.collapsed&&(n.previousSibling?e.setEndBefore(n):n.parentNode&&n.parentNode!=t&&e.setEndBefore(n.parentNode),e.endContainer!=n););}catch(i){d(i,"fixSelection, while trying to set end")}try{for(;(n=e.startContainer)&&n!=t&&!e.collapsed&&(n=e.startContainer,n.nodeType==ice.dom.TEXT_NODE?e.startOffset>=n.nodeValue.length&&e.setStartAfter(n):e.startOffset>=n.childNodes.length&&e.setStartAfter(n),e.startContainer!=n););}catch(i){d(i,"fixSelection, while trying to set start")}}function i(e,t){function n(e){return e?(e=e.replace("/\n/g","\\n").replace("/\r/g","").replace("​","{filler}").replace("﻿","{filler}"),e.length<=15?e:e.substring(0,5)+"..."+e.substring(e.length-5)):""}function i(e){var t;if(3===e.nodeType)t="Text:"+n(e.nodeValue);else{var i=e.innerText;t=e.nodeName+(i?"("+n(i)+")":"")}o.push("<"+t+" />")}function r(e,t,r){if("number"!=typeof r&&(r=-1),3==e.nodeType){var a=e.nodeValue;o.push(n(a.substring(0,t))),o.push("|"),r>t?(o.push(n(a.substring(t,r))),o.push("|"),o.push(n(a.substring(r)))):o.push(n(a.substring(t)))}else if(1==e.nodeType){var s=0,d=e.childNodes;for(start=s>6?s-5:0,i(e),start>0&&o.push("(..."+start+" nodes)"),s=start;t>s;++s)i(d[s]);if(o.push("|"),r>t){for(s=t;r>s;++s)i(d[s]);o.push("|")}if(r>0&&r<d.length)for(var c=d[r];c;)i(c),c=c.nextSibling}}if(e&&e.startContainer&&e.endContainer){var o=[];e.startContainer===e.endContainer?r(e.startContainer,e.startOffset,e.endOffset):(r(e.startContainer,e.startOffset),r(e.endContainer,e.endOffset));var a=o.join(" ");return t&&s.log(t+":"+a),a}}var r,o,a=this;r={attributes:{changeId:"data-cid",userId:"data-userid",userName:"data-username",sessionId:"data-session-id",time:"data-time",lastTime:"data-last-change-time",changeData:"data-changedata"},attrValuePrefix:"",blockEl:"p",blockEls:["div","p","ol","ul","li","h1","h2","h3","h4","h5","h6","blockquote"],stylePrefix:"cts",currentUser:{id:null,name:null},changeTypes:{insertType:{tag:"span",alias:"ins",action:"Inserted"},deleteType:{tag:"span",alias:"del",action:"Deleted"}},handleEvents:!1,contentEditable:void 0,_isTracking:!0,tooltips:!1,tooltipsDelay:1,mergeBlocks:!0,_isVisible:!0,_changeData:null,_handleSelectAll:!1,_sessionId:null},o=function(e){if(e||(e={}),!e.element)throw new Error("options.element must be defined for ice construction.");if(this._changes={},this._userStyles={},this._styles={},this._refreshInterval=null,this.$this=jQuery(this),this._browser=ice.dom.browser(),this._tooltipMouseOver=this._tooltipMouseOver.bind(this),this._tooltipMouseOut=this._tooltipMouseOut.bind(this),ice.dom.extend(!0,this,r,e),e.tooltips&&(!jQuery.isFunction(e.hostMethods.showTooltip)||!jQuery.isFunction(e.hostMethods.hideTooltip)))throw new Error("hostMethods.showTooltip and hostMethods.hideTooltip must be defined if tooltips is true");var t=e.userStyles||{};for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];isNaN(i)||(this._userStyles[n]=this.stylePrefix+"-"+i,this._uniqueStyleIndex=Math.max(i,this._uniqueStyleIndex),this._styles[i]=!0)}d=e.hostMethods.logError||function(){return void 0}},o.prototype={_uniqueStyleIndex:0,_browserType:null,_batchChangeId:null,_uniqueIDIndex:1,_delBookmark:"tempdel",isPlaceHoldingDeletes:!1,startTracking:function(){if("boolean"==typeof this.contentEditable&&this.element.setAttribute("contentEditable",this.contentEditable),this.handleEvents){var e=this;ice.dom.bind(e.element,"keyup.ice keydown.ice keypress.ice",function(t){return e._handleEvent(t)})}return this.initializeEnvironment(),this.initializeEditor(),this.initializeRange(),this._updateTooltipsState(),this},stopTracking:function(e){this._isTracking=!1;try{this.element&&ice.dom.unbind(this.element,"keyup.ice keydown.ice keypress.ice"),e||"undefined"==typeof this.contentEditable||this.element.setAttribute("contentEditable",!this.contentEditable)}catch(t){d(t,"While trying to stop tracking")}return this._updateTooltipsState(),this},initializeEnvironment:function(){this.env||(this.env={}),this.env.element=this.element,this.env.document=this.element.ownerDocument,this.env.window=this.env.document.defaultView||this.env.document.parentWindow||window,this.env.frame=this.env.window.frameElement,this.env.selection=this.selection=new ice.Selection(this.env)},initializeRange:function(){},initializeEditor:function(){this._loadFromDom(),this._updateTooltipsState()},isTracking:function(){return this._isTracking},enableChangeTracking:function(){this._isTracking=!0},disableChangeTracking:function(){this._isTracking=!1},toggleChangeTracking:function(e){e=void 0===e?!this._isTracking:!!e,this._isTracking=e},setCurrentUser:function(e){this.currentUser=e,this._updateUserData(e)},setSessionId:function(e){this._sessionId=e},toggleTooltips:function(e){e=void 0===e?!this.tooltips:!!e,this.tooltips=e,this._updateTooltipsState()},visible:function(e){e.nodeType===ice.dom.TEXT_NODE&&(e=e.parentNode);var t=e.getBoundingClientRect();return t.top>0&&t.left>0},_createIceNode:function(e,t){var n=this.env.document.createElement(this.changeTypes[e].tag);return ice.dom.addClass(n,this._getIceNodeClass(e)),t&&n.appendChild(t),this._addChange(this.changeTypes[e].alias,[n]),n},insert:function(e){this.hostMethods.beforeInsert&&this.hostMethods.beforeInsert();var t=this.getCurrentRange(),n=this._isRangeInElement(t,this.element),i=n?null:this.hostMethods.getHostRange(),r=this._startBatchChange(),o=!(!n||n.collapsed),a=!0;try{if(o&&(this._deleteContents(!1,n),n=this.getCurrentRange()),n||i){var s=e&&e.nodes;s&&!jQuery.isArray(s)&&(s=[s]),this._moveRangeToValidTrackingPos(n,i),a=!this._insertNodes(n,i,{nodes:s,text:e&&e.text})}}catch(c){d(c,"while trying to insert nodes")}finally{this._endBatchChange(r)}return a},_deleteContents:function(e,t){var n=!0,i=this._browser;this.hostMethods.beforeDelete&&this.hostMethods.beforeDelete(),t?this.selection.addRange(t):t=this.getCurrentRange();var r=this._startBatchChange();try{if(t.collapsed===!1)t=this._deleteSelection(t),t&&!this.visible(t.endContainer)&&(t.setEnd(t.endContainer,Math.max(0,t.endOffset-1)),t.collapse(!1));else if(e)if("mozilla"===i.type)n=this._deleteRight(t),this.visible(t.endContainer)||(t.endContainer.parentNode.nextSibling?t.setEndBefore(t.endContainer.parentNode.nextSibling):t.setEndAfter(t.endContainer),t.collapse(!1));else{if(t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var o=t.startContainer.nextSibling;if(ice.dom.is(o,"."+this._getIceNodeClass("deleteType")))for(;o;){if(!ice.dom.is(o,"."+this._getIceNodeClass("deleteType"))){t.setStart(o,0),t.collapse(!0);break}o=o.nextSibling}}n=this._deleteRight(t),this.visible(t.endContainer)||ice.dom.is(t.endContainer.parentNode,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&(t.setStartAfter(t.endContainer.parentNode),t.collapse(!0))}else if(i.mozilla)n=this._deleteLeft(t),this.visible(t.startContainer)||(t.startContainer.parentNode.previousSibling?t.setEnd(t.startContainer.parentNode.previousSibling,0):t.setEnd(t.startContainer.parentNode,0),t.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(t.endContainer)),t.collapse(!1));else{if(!this.visible(t.startContainer)&&t.endOffset===ice.dom.getNodeCharacterLength(t.endContainer)){var a=t.startContainer.previousSibling;if(ice.dom.is(a,"."+this._getIceNodeClass("deleteType")))for(;a;){if(!ice.dom.is(a,"."+this._getIceNodeClass("deleteType"))){t.setEndBefore(a.nextSibling,0),t.collapse(!1);break}a=a.prevSibling}}n=this._deleteLeft(t)}t&&this.selection.addRange(t)}finally{this._endBatchChange(r)}return n},getChanges:function(){return this._changes},getChangeUserids:function(){var e=[],t=Object.keys(this._changes);for(var n in t)e.push(this._changes[t[n]].userid);return e.sort().filter(function(e,t,n){return t==n.indexOf(e)?1:0})},getElementContent:function(){return this.element.innerHTML},getCleanContent:function(e,t,n){var i=this.getCleanDOM(e,{callback:t,prepare:n,clone:!0});return i&&i.innerHTML||""},getCleanDOM:function(e,t){var n="",i=this;return t=t||{},ice.dom.each(this.changeTypes,function(e,t){"deleteType"!=e&&(t>0&&(n+=","),n+="."+i._getIceNodeClass(e))}),e?"string"==typeof e?e=ice.dom.create("<div>"+e+"</div>"):t.clone&&(e=ice.dom.cloneNode(e,!1)[0]):e=t.clone?ice.dom.cloneNode(this.element,!1)[0]:this.element,this._cleanBody(e,n,t)},_cleanBody:function(e,t,n){e=n.prepare?n.prepare.call(this,e):e;var i=ice.dom.find(e,t);ice.dom.each(i,function(e,t){for(;t.firstChild;)t.parentNode.insertBefore(t.firstChild,t);t.parentNode.removeChild(t)});var r=ice.dom.find(e,"."+this._getIceNodeClass("deleteType"));return ice.dom.remove(r),e=n.callback?n.callback.call(this,e):e},acceptAll:function(e){return e?this._acceptRejectSome(e,!0):(this.getCleanDOM(this.element,{clone:!1}),this._changes={},this._triggerChange(),void 0)},rejectAll:function(e){if(e)return this._acceptRejectSome(e,!1);var t,n="."+this._getIceNodeClass("insertType"),i="."+this._getIceNodeClass("deleteType"),r=this;ice.dom.find(this.element,n).each(function(e,t){r._removeNode(t)}),ice.dom.each(ice.dom.find(this.element,i),function(e,n){t=ice.dom.contents(n),ice.dom.replaceWith(n,t),jQuery.each(t,function(e,t){var n=t&&t.parentNode;ice.dom.normalizeNode(n)})}),this._changes={},this._triggerChange()},acceptChange:function(e){this.acceptRejectChange(e,!0)},rejectChange:function(e){this.acceptRejectChange(e,!1)},acceptRejectChange:function(e,t){var n,i,r,o,a,s,d,c,l,u=ice.dom,h=this;if(!e){var f=this.getCurrentRange();if(!f.collapsed)return;e=f.startContainer}n=o="."+this._getIceNodeClass("deleteType"),i=a="."+this._getIceNodeClass("insertType"),t||(o=i,a=n),r=n+","+i,s=u.getNode(e,r),l=u.attr(s,this.attributes.changeId),d=u.find(this.element,o+"["+this.attributes.changeId+"="+l+"]"),c=d.length,d.each(function(e,t){h._removeNode(t)}),u.remove(d),d=u.find(this.element,a+"["+this.attributes.changeId+"="+l+"]"),c+=d.length,u.each(d,function(e,t){content=ice.dom.contents(t),u.replaceWith(t,content),jQuery.each(content,function(e,t){var n=ice.dom.TEXT_NODE==t.nodeType&&t.nodeValue;if(n){for(var i=!1;n.indexOf("  ")>=0;)i=!0,n=n.replace("  ","  ");i&&(t.nodeValue=n)}var r=t&&t.parentNode;ice.dom.normalizeNode(r)})}),delete this._changes[l],c>0&&this._triggerChange()},isInsideChange:function(e,t){try{return!!this.currentChangeNode(e,t)}catch(n){return d(n,"While testing if isInsideChange"),!1}},getIceNodes:function(){var e=[],t=this;return ice.dom.each(this.changeTypes,function(n){e.push("."+t._getIceNodeClass(n))}),e=e.join(","),jQuery(this.element).find(e)},_getIceNode:function(e,t){var n="."+this._getIceNodeClass(t);return ice.dom.getNode(e&&e.$||e,n)},_moveRangeToValidTrackingPos:function(n,i){if(n=i||n)for(var r,o,a,s,c,l=-1,u=[],h=i?this.hostMethods.getHostNode:e,f=!1;!f;){if(o=n.startContainer,!o||u.indexOf(o)>=0)return;if(a=h(o),u.push(o),r=this._getVoidElement(a)){if(r!=o&&u.indexOf(r)>=0)return;u.push(r)}else f=ice.dom.isTextContainer(a);if(!f){-1==l&&(l=!t(h(n.startContainer),n.startOffset)),s=l?ice.dom.findPrevTextContainer(r||a,this.element):ice.dom.findNextTextContainer(r||a,this.element),c=s.node,i&&(c=this.hostMethods.makeHostElement(c));try{l?n.setStart(c,s.offset):n.setEnd(c,s.offset),n.collapse(l)}catch(g){d(g,"While trying to move range to valid tracking position");break}}}},_isRangeInElement:function(e,t){for(var n=e&&e.startContainer;n;){if(n==t)return e;n=n.parentNode}return null},_getVoidElement:function(e){try{var t=this._getVoidElSelector(),n=ice.dom.is(e,t)?e:ice.dom.parents(e,t)[0]||null;return n||3!=e.nodeType||"​"!=e.nodeValue?n:e}catch(i){return d(i,"While trying to get void element of",e),null}},_isEmptyTextNode:function(e){if(!e||ice.dom.TEXT_NODE!==e.nodeType)return!1;var t=e.nodeValue;return""===t||"​"===t||"﻿"===t},_cleanupSelection:function(e,t){var n;if(e&&e.collapsed&&(n=e.startContainer)){t&&(n=this.hostMethods.getHostNode(n));var i=n.nodeType;return ice.dom.TEXT_NODE==i?this._cleanupTextSelection(e,n,t):this._cleanupElementSelection(e,t)}},_cleanupTextSelection:function(t,n,i){if(this._cleanupAroundNode(n),this._isEmptyTextNode(n)){var r=n.parentNode,o=ice.dom.getNodeIndex(n),a=i?this.hostMethods.makeHostElement:e;r.removeChild(n),o=Math.max(0,o-1),t.setStart(a(r),o),t.setEnd(a(r),o)}},_cleanupElementSelection:function(t,n){var i,r=!1,o=n?this.hostMethods.getHostNode(t.startContainer):t.startContainer,a=o.childNodes.length;if(!(1>a)){try{if(t.startOffset>0?i=o.childNodes[t.startOffset-1]:(i=o.firstChild,r=!0),!i)return}catch(s){return}if(this._cleanupAroundNode(i,r),0!==t.startOffset){var d=ice.dom.getNodeIndex(i)+1;if(this._isEmptyTextNode(i)&&(d=Math.max(0,d-1),o.removeChild(i)),o.childNodes.length!=a){var c=n?this.hostMethods.makeHostElement:e;t.setStart(c(o),d),t.setEnd(c(o),d)}}}},_cleanupAroundNode:function(e,t){var n,i=e.parentNode,r=e.nextSibling;for(childCount=i.childNodes.length;r;)this._isEmptyTextNode(r)?(n=r,r=r.nextSibling,i.removeChild(n)):r=r.nextSibling;for(r=e.previousSibling;r;)this._isEmptyTextNode(r)?(n=r,r=r.previousSibling,i.removeChild(n)):r=r.previousSibling;t&&this._isEmptyTextNode(e)&&i.removeChild(e)},_getVoidElSelector:function(){return"."+this._getIceNodeClass("deleteType")},_currentUserIceNode:function(e){var t=e&&ice.dom.attr(e,this.attributes.userId)==this.currentUser.id;return t&&this._sessionId&&(t=ice.dom.attr(e,this.attributes.sessionId)===this._sessionId),t},_getChangeTypeFromAlias:function(e){var t,n=null;for(t in this.changeTypes)this.changeTypes.hasOwnProperty(t)&&this.changeTypes[t].alias==e&&(n=t);return n},_getIceNodeClass:function(e){return this.attrValuePrefix+this.changeTypes[e].alias},_getUserStyle:function(e){if(null===e||""===e||"undefined"==typeof e)return this.stylePrefix;var t=null;return t=this._userStyles[e]?this._userStyles[e]:this._setUserStyle(e,this._getNewStyleId())},_setUserStyle:function(e,t){var n=this.stylePrefix+"-"+t;return this._styles[t]||(this._styles[t]=!0),this._userStyles[e]=n},_getNewStyleId:function(){var e=++this._uniqueStyleIndex;return this._styles[e]?this._getNewStyleId():(this._styles[e]=!0,e)},_addChange:function(e,t){var n=this._batchChangeId||this.getNewChangeId(),i=this;if(!this._changes[n]){var r=(new Date).getTime();this._changes[n]={type:this._getChangeTypeFromAlias(e),time:r,lastTime:r,sessionId:this._sessionId,userid:String(this.currentUser.id),username:this.currentUser.name,data:this._changeData||""},this._triggerChange()}return ice.dom.foreach(t,function(e){i._addNodeToChange(n,t[e])}),n},_addNodeToChange:function(e,t){e=this._batchChangeId||e;var n=this.getChange(e);t.getAttribute(this.attributes.changeId)||t.setAttribute(this.attributes.changeId,e);var i=t.getAttribute(this.attributes.userId);i||t.setAttribute(this.attributes.userId,i=n.userid),i==n.userid&&t.setAttribute(this.attributes.userName,n.username);var r=t.getAttribute(this.attributes.changeData);null==r&&t.setAttribute(this.attributes.changeData,this._changeData||""),t.getAttribute(this.attributes.time)||t.setAttribute(this.attributes.time,n.time),t.getAttribute(this.attributes.lastTime)||t.setAttribute(this.attributes.lastTime,n.lastTime),n.sessionId&&!t.getAttribute(this.attributes.sessionId)&&t.setAttribute(this.attributes.sessionId,n.sessionId);var o=this._getUserStyle(n.userid);ice.dom.hasClass(t,o)||ice.dom.addClass(t,o),this._updateNodeTooltip(t)},getChange:function(e){return this._changes[e]||null},getNewChangeId:function(){var e=++this._uniqueIDIndex;return this._changes[e]&&(e=this.getNewChangeId()),e},_startBatchChange:function(){return this._batchChangeId?null:this._batchChangeId=this.getNewChangeId()},getContentElement:function(){return this.element},_endBatchChange:function(e){e&&e===this._batchChangeId&&(this._batchChangeId=null,this._triggerChangeText())},getCurrentRange:function(){try{return this.selection.getRangeAt(0)}catch(e){return d(e,"While trying to get current range"),null}},_insertNodes:function(t,n,i){var r=n||t,o=r.startContainer,a=o&&o.$||o,s=n?this.hostMethods.makeHostElement:e,d=i&&i.nodes,c=i&&i.text,l=this.env.document,u=!1,h=this._getIceNode(a,"insertType"),f=this._currentUserIceNode(h);if(f){var g=d&&d[0],m=h.getAttribute(this.attributes.changeId);if(g){u=!0,r.insertNode(s(g));for(var p=g.parentNode,v=g.nextSibling,C=d.length,N=1;C>N;++N)v?p.insertBefore(d[N],v):p.appendChild(d[N]);var T=d[C-1];ice.dom.TEXT_NODE==T.nodeType?r.setEnd(T,T.nodeValue&&T.nodeValue.length||0):r.setEndAfter(T),r.collapse(),n?this.hostMethods.setHostRange(n):this.selection.addRange(r)}this._updateChangeTime(m)}else{var E=this._createIceNode("insertType");if(h){var y=h.childNodes.length;if(ice.dom.normalizeNode(h),y!=h.childNodes.length&&(n?n=r=this.hostMethods.getHostRange():r.refresh()),h){var _=n&&this.hostMethods.getHostNode(n.endContainer)||r.endContainer;(3==_.nodeType&&r.endOffset<r.endContainer.length||_!=h.lastChild)&&(h=this._splitNode(h,r.endContainer,r.endOffset))}}h&&(r.setStartAfter(s(h)),r.collapse(!0)),this._cleanupSelection(r,!!n),r.insertNode(s(E));var C=d&&d.length||0;if(C){u=!0;for(var N=0;C>N;++N)E.appendChild(d[N]);r.setEndAfter(s(E.lastChild)),r.collapse()}else if(c){u=!0;var S=l.createTextNode(c);E.appendChild(S),r.setEnd(S,1),r.collapse()}else{var S=l.createTextNode("﻿");E.appendChild(S),S=s(S),r.setStart(S,0),r.setEnd(S,1)}n?this.hostMethods.setHostRange(n):this.selection.addRange(r)}return u},_updateChangeTime:function(e){var t=this._changes[e];if(t){var n=(new Date).getTime(),i=ice.dom.find(this.element,"["+this.attributes.changeId+"="+e+"]"),r=this.attributes.lastTime;t.lastTime=n,i.each(function(e,t){t.setAttribute(r,n)})}},_handleVoidEl:function(e,t){var n=e&&this._getVoidElement(e);return n&&!this._getIceNode(n,"deleteType")?(t.collapse(!0),!0):!1},_deleteSelection:function(e){for(var t=new ice.Bookmark(this.env,e),n=ice.dom.getElementsBetween(t.start,t.end),i=ice.dom.parents(e.startContainer,this.blockEls.join(", "))[0],r=ice.dom.parents(e.endContainer,this.blockEls.join(", "))[0],o=new Array,a=0;a<n.length;a++){var s=n[a];if(s&&s.parentNode)if(!ice.dom.isBlockElement(s)||(o.push(s),ice.dom.canContainTextElement(s))){if((s.nodeType!==ice.dom.TEXT_NODE||0!==ice.dom.getNodeTextContent(s).length)&&!this._getVoidElement(s)){if(s.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(s))continue;
if(ice.dom.isStubElement(s)){this._addDeleteTracking(s,{range:null,moveLeft:!0});continue}if(ice.dom.hasNoTextOrStubContent(s)){this._removeNode(s);continue}for(var d=0;d<s.childNodes.length;d++){var c=s.childNodes[d];n.push(c)}continue}var l=ice.dom.getBlockParent(s);this._addDeleteTracking(s,{range:null,moveLeft:!0}),ice.dom.hasNoTextOrStubContent(l)&&ice.dom.remove(l)}}else for(var u=0;u<s.childNodes.length;u++)n.push(s.childNodes[u])}if(this.mergeBlocks&&i!==r){for(;o.length;)ice.dom.mergeContainers(o.shift(),i);ice.dom.mergeContainers(r,i)}return t.selectBookmark(),(e=this.getCurrentRange())&&e.collapse(!0),e},_deleteRight:function(e){var t,n,i=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,r=i?ice.dom.hasNoTextOrStubContent(i):!1,o=i&&ice.dom.getNextContentNode(i,this.element),a=o?ice.dom.hasNoTextOrStubContent(o):!1,s=e.endContainer,d=e.endOffset,c=e.commonAncestorContainer;if(r)return!1;if(c.nodeType!==ice.dom.TEXT_NODE){if(0===d&&ice.dom.isBlockElement(c)&&!ice.dom.canContainTextElement(c)){var l=c.firstElementChild;if(l)return e.setStart(l,0),e.collapse(),this._deleteRight(e)}if(c.childNodes.length>d){var u=document.createTextNode(" ");c.insertBefore(u,c.childNodes[d]),e.setStart(u,1),e.collapse(!0),n=this._deleteRight(e);{u.parentNode}return this._removeNode(u),e.refresh(),n}return t=ice.dom.getNextContentNode(c,this.element),e.setEnd(t,0),e.collapse(),this._deleteRight(e)}if(e.moveEnd(ice.dom.CHARACTER_UNIT,1),e.moveEnd(ice.dom.CHARACTER_UNIT,-1),d===s.data.length&&!ice.dom.hasNoTextOrStubContent(s)){if(t=ice.dom.getNextNode(s,this.element),!t)return e.selectNodeContents(s),e.collapse(),!1;if(ice.dom.BREAK_ELEMENT==ice.dom.getTagName(t)&&(t=ice.dom.getNextNode(t,this.element)),t.nodeType===ice.dom.TEXT_NODE&&(t=t.parentNode),!t.isContentEditable){n=this._addDeleteTracking(t,{range:null,moveLeft:!1,merge:!0});var h=this.env.document.createTextNode("");return t.parentNode.insertBefore(h,t.nextSibling),e.selectNode(h),e.collapse(!0),n}if(this._handleVoidEl(t,e))return!0;if(ice.dom.isChildOf(t,i)&&ice.dom.isStubElement(t))return this._addDeleteTracking(t,{range:e,moveLeft:!1,merge:!0})}if(this._handleVoidEl(t,e))return!0;if(ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(t,this.element),this.blockEl)){o!==ice.dom.getBlockParent(e.endContainer,this.element)&&e.setEnd(o,0);for(var f=ice.dom.getElementsBetween(e.startContainer,e.endContainer),g=0;g<f.length;g++)ice.dom.remove(f[g]);var m=e.startContainer,p=e.endContainer;return ice.dom.remove(ice.dom.find(m,"br")),ice.dom.remove(ice.dom.find(p,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||i)}return a?(ice.dom.remove(o),e.collapse(!0),!0):(e.setStart(o,0),e.collapse(!0),!0)}{var v=e.endContainer,C=v.splitText(e.endOffset);C.splitText(1)}return this._addDeleteTracking(C,{range:e,moveLeft:!1,merge:!0})},_deleteLeft:function(e){var t,n,i=ice.dom.isBlockElement(e.startContainer)&&e.startContainer||ice.dom.getBlockParent(e.startContainer,this.element)||null,r=i?ice.dom.hasNoTextOrStubContent(i):!1,o=i&&ice.dom.getPrevContentNode(i,this.element),a=o?ice.dom.hasNoTextOrStubContent(o):!1,s=e.startContainer,d=e.startOffset,c=e.commonAncestorContainer;if(r)return!1;if(0===d||c.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isBlockElement(c)&&!ice.dom.canContainTextElement(c))if(0===d){var l=c.firstElementChild;if(l)return e.setStart(l,0),e.collapse(),this._deleteLeft(e)}else{var u=c.lastElementChild;if(u&&(t=e.getLastSelectableChild(u)))return e.setStart(t,t.data.length),e.collapse(),this._deleteLeft(e)}if(n=0===d?ice.dom.getPrevContentNode(s,this.element):c.childNodes[d-1],!n)return!1;if(ice.dom.is(n,"."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType"))&&n.childNodes.length>0&&n.lastChild&&(n=n.lastChild),n.nodeType===ice.dom.TEXT_NODE&&(n=n.parentNode),!n.isContentEditable){var h=this._addDeleteTracking(n,{range:null,moveLeft:!0,merge:!0}),f=document.createTextNode("");return n.parentNode.insertBefore(f,n),e.selectNode(f),e.collapse(!0),h}if(this._handleVoidEl(n,e))return!0;if(ice.dom.isStubElement(n)&&ice.dom.isChildOf(n,i)||!n.isContentEditable)return this._addDeleteTracking(n,{range:e,moveLeft:!0,merge:!0});if(ice.dom.isStubElement(n))return ice.dom.remove(n),e.collapse(!0),!1;if(n!==i&&!ice.dom.isChildOf(n,i)){if(ice.dom.canContainTextElement(n)||(n=n.lastElementChild),n.lastChild&&n.lastChild.nodeType!==ice.dom.TEXT_NODE&&ice.dom.isStubElement(n.lastChild)&&"BR"!==n.lastChild.tagName)return e.setStartAfter(n.lastChild),e.collapse(!0),!0;if(t=e.getLastSelectableChild(n),t&&!ice.dom.isOnBlockBoundary(e.startContainer,t,this.element))return e.selectNodeContents(t),e.collapse(),!0}}if(1===d&&!ice.dom.isBlockElement(c)&&e.startContainer.childNodes.length>1&&e.startContainer.childNodes[0].nodeType===ice.dom.TEXT_NODE&&0===e.startContainer.childNodes[0].data.length)return e.setStart(e.startContainer,0),this._deleteLeft(e);if(e.moveStart(ice.dom.CHARACTER_UNIT,-1),e.moveStart(ice.dom.CHARACTER_UNIT,1),ice.dom.isOnBlockBoundary(e.startContainer,e.endContainer,this.element)){if(a)return ice.dom.remove(o),e.collapse(),!0;if(this.mergeBlocks&&ice.dom.is(ice.dom.getBlockParent(n,this.element),this.blockEl)){o!==ice.dom.getBlockParent(e.startContainer,this.element)&&e.setStart(o,o.childNodes.length);for(var g=ice.dom.getElementsBetween(e.startContainer,e.endContainer),m=0;m<g.length;m++)ice.dom.remove(g[m]);var p=e.startContainer,v=e.endContainer;return ice.dom.remove(ice.dom.find(p,"br")),ice.dom.remove(ice.dom.find(v,"br")),ice.dom.mergeBlockWithSibling(e,ice.dom.getBlockParent(e.endContainer,this.element)||i)}return o&&o.lastChild&&ice.dom.isStubElement(o.lastChild)?(e.setStartAfter(o.lastChild),e.collapse(!0),!0):(t=e.getLastSelectableChild(o),t?(e.setStart(t,t.data.length),e.collapse(!0)):o&&(e.setStart(o,o.childNodes.length),e.collapse(!0)),!0)}var C=e.startContainer,N=C.splitText(e.startOffset-1);return N.splitText(1),this._addDeleteTracking(N,{range:e,moveLeft:!0,merge:!0})},_removeNode:function(e){var t=e&&e.parentNode;t&&(t.removeChild(e),ice.dom.hasNoTextOrStubContent(t)&&"BODY"!=t.nodeName&&this._removeNode(t))},_addDeleteTracking:function(e,t){var n,i=this._getIceNode(e,"insertType");if(i)return this._addDeletionInInsertNode(e,i,t);var r=t&&t.range;if(r&&this._getIceNode(e,"deleteType"))return this._deleteInDeleted(e,t);e.previousSibling&&e.previousSibling.nodeType===ice.dom.TEXT_NODE&&0===e.previousSibling.length&&e.parentNode.removeChild(e.previousSibling),e.nextSibling&&e.nextSibling.nodeType===ice.dom.TEXT_NODE&&0===e.nextSibling.length&&e.parentNode.removeChild(e.nextSibling);var o=this._getIceNode(e.previousSibling,"deleteType"),a=this._getIceNode(e.nextSibling,"deleteType");if(o&&this._currentUserIceNode(o)){if(n=o,n.appendChild(e),a&&this._currentUserIceNode(a)){var s=ice.dom.extractContent(a);ice.dom.append(n,s),a.parentNode.removeChild(a)}}else a&&this._currentUserIceNode(a)?(n=a,n.insertBefore(e,n.firstChild)):(n=this._createIceNode("deleteType"),e.parentNode.insertBefore(n,e),n.appendChild(e));if(r){var d=t&&t.moveLeft;ice.dom.isStubElement(e)?r.selectNode(e):r.selectNodeContents(e),d?r.collapse(!0):r.collapse(),ice.dom.normalizeNode(e)}return!0},_deleteInDeleted:function(e,t){var n,i=t.range,r=t.moveLeft;ice.dom.normalizeNode(e);var o=!1;if(r){for(var a=ice.dom.getPrevContentNode(e,this.element);!o;)n=this._getIceNode(a,"deleteType"),n?a=ice.dom.getPrevContentNode(a,this.element):o=!0;if(a){var s=i.getLastSelectableChild(a);s&&(a=s),i.setStart(a,ice.dom.getNodeCharacterLength(a)),i.collapse(!0)}}else{for(var d=ice.dom.getNextContentNode(e,this.element);!o;)n=this._getIceNode(d,"deleteType"),n?d=ice.dom.getNextContentNode(d,this.element):o=!0;d&&(i.selectNodeContents(d),i.collapse(!0))}return!0},_addDeletionInInsertNode:function(e,t,n){var i=n&&n.range,r=n&&n.moveLeft;if(this._currentUserIceNode(t)){i&&(r?i.setStartBefore(e):i.setStartAfter(e),i.collapse(r)),e.parentNode.removeChild(e),this._browser.msie||ice.dom.normalizeNode(t);var o,a=ice.dom.find(t,".iceBookmark").length;a>0?(o=ice.dom.cloneNode(t),ice.dom.remove(ice.dom.find(o,".iceBookmark")),o=o[0]):o=t,ice.dom.hasNoTextOrStubContent(o)&&(i&&(i.setStartBefore(t),i.collapse(!0)),ice.dom.replaceWith(t,ice.dom.contents(t)))}else{var s,d=rangy.dom.getNodeIndex(e),c=e.parentNode,l=c.childNodes.length;c.removeChild(e),s=this._createIceNode("deleteType"),s.appendChild(e),d>0&&d>=l-1?t.parentNode.appendChild(s):(d>0&&this._splitNode(t,c,d),t.parentNode.insertBefore(s,t)),this._deleteEmptyNode(t),i&&r&&(i.setStartBefore(s),i.collapse(!0),this.selection.addRange(i)),n&&n.merge&&this._mergeDeleteNode(s),i&&i.refresh()}return!0},_deleteEmptyNode:function(e){var t=e&&e.parentNode;t&&ice.dom.hasNoTextOrStubContent(e)&&t.removeChild(e)},_mergeDeleteNode:function(e){var t,n;this._currentUserIceNode(t=this._getIceNode(e.previousSibling,"deleteType"))?(n=ice.dom.extractContent(e),e.parentNode.removeChild(e),ice.dom.append(t,n),this._mergeDeleteNode(t)):this._currentUserIceNode(t=this._getIceNode(e.nextSibling,"deleteType"))&&(n=ice.dom.extractContent(t),e.parentNode.removeChild(t),ice.dom.append(e,n),this._mergeDeleteNode(e))},_handleEvent:function(e){if(!this._isTracking)return!0;var t=!0;return"keypress"==e.type?t=this.keyPress(e):"keydown"==e.type&&(t=this.keyDown(e)),t||e.preventDefault(),t},_handleAncillaryKey:function(e){var t=e.keyCode?e.keyCode:e.which,n=this._browser,i=!0,r=(e.shiftKey,this),o=r.getCurrentRange();switch(t){case ice.dom.DOM_VK_DELETE:i=this._deleteContents();break;case 46:i=this._deleteContents(!0);break;case ice.dom.DOM_VK_DOWN:case ice.dom.DOM_VK_UP:case ice.dom.DOM_VK_LEFT:"mozilla"===n.type&&(this.visible(o.startContainer)||(o.startContainer.parentNode.previousSibling?(o.setEnd(o.startContainer.parentNode.previousSibling,0),o.moveEnd(ice.dom.CHARACTER_UNIT,ice.dom.getNodeCharacterLength(o.endContainer)),o.collapse(!1)):(o.setEnd(o.startContainer.parentNode.nextSibling,0),o.collapse(!1)))),i=!1;break;case ice.dom.DOM_VK_RIGHT:"mozilla"===n.type&&(this.visible(o.startContainer)||o.startContainer.parentNode.nextSibling&&(o.setStart(o.startContainer.parentNode.nextSibling,0),o.collapse(!0))),i=!1;break;default:i=!1}return i===!0?(ice.dom.preventDefault(e),!1):!0},keyDown:function(e){var t=!1;if(this._handleSpecialKey(e)===!1)return ice.dom.isBrowser("msie")!==!0&&(this._preventKeyPress=!0),!1;switch(e.keyCode){case 27:break;default:t=!this._handleAncillaryKey(e)}return t?(ice.dom.preventDefault(e),!1):!0},keyPress:function(e){if(this._preventKeyPress===!0)return void(this._preventKeyPress=!1);var t=null;if(null==e.which?t=String.fromCharCode(e.keyCode):e.which>0&&(t=String.fromCharCode(e.which)),e.ctrlKey||e.metaKey)return!0;var n=this.getCurrentRange(),i=n&&ice.dom.parents(n.startContainer,"br")[0]||null;if(i&&n.moveToNextEl(i),null!==t&&e.ctrlKey!==!0&&e.metaKey!==!0){var r=e.keyCode?e.keyCode:e.which;switch(r){case ice.dom.DOM_VK_DELETE:return this._handleAncillaryKey(e);case ice.dom.DOM_VK_ENTER:return this._handleEnter();default:return this.insert({text:t})}}return this._handleAncillaryKey(e)},_handleEnter:function(){var e=this.getCurrentRange();return e&&!e.collapsed&&this._deleteContents(),!0},_handleSpecialKey:function(e){var t=e.which;null===t&&(t=e.keyCode);var n=!1;switch(t){case 120:case 88:(!0===e.ctrlKey||!0===e.metaKey)&&this.prepareToCut();break;case 67:case 99:(!0===e.ctrlKey||!0===e.metaKey)&&this.prepareToCopy()}return n===!0?(ice.dom.preventDefault(e),!1):!0},currentChangeNode:function(e,t){var n="."+this._getIceNodeClass("insertType")+", ."+this._getIceNodeClass("deleteType");if(!e){var i=this.getCurrentRange();if(!i)return!1;e=i.collapsed?i.startContainer:i.commonAncestorContainer}return e&&(t?ice.dom.is(e,n):ice.dom.getNode(e,n))},setShowChanges:function(e){e=!!e,this._isVisible=e;var t=jQuery(this.element);t.toggleClass("ICE-Tracking",e),this._showTitles(e),this._updateTooltipsState()},reload:function(){this._loadFromDom()},hasChanges:function(){for(var e in this._changes){var t=this._changes[e];if(t&&t.type)return!0}return!1},countChanges:function(e){var t=this._filterChanges(e);return t.count},setChangeData:function(e){(null==e||"undefined"==typeof e)&&(e=""),this._changeData=String(e)},getDeleteClass:function(){return this._getIceNodeClass("deleteType")},prepareToCopy:function(){var e=this.getCurrentRange();e&&!e.collapsed&&this._removeTrackingInRange(e)},prepareToCut:function(){var e=this.getCurrentRange(),t=this.hostMethods.getHostRange();if(e&&t&&e.collapsed&&!t.collapsed)try{var i=this.hostMethods.getHostRangeData(t);e.setStart(i.startContainer,i.startOffset),e.setEnd(i.endContainer,i.endOffset)}catch(r){return}if(!e||e.collapsed)return!1;n(e,this.element);var o=e.cloneContents(),a=e.cloneRange(),s=o.firstChild,c=o.lastChild;this.hostMethods.beforeEdit(),e.collapse(!1),e.insertNode(o),e.setStartBefore(s),e.setEndAfter(c);var l=this._startBatchChange();try{this._deleteSelection(e)}catch(r){d(r,"While trying to delete selection")}finally{this._endBatchChange(l),this.selection.addRange(a),this._removeTrackingInRange(a,!1)}return!0},toString:function(){return"ICE "+(this.element&&this.element.id||"(no element id)")},_splitNode:function(e,t,n){var i,r=e.parentNode,o=rangy.dom.getNodeIndex(e),a=t.ownerDocument,s=a.createRange();return s.setStart(r,o),s.setEnd(t,n),i=s.extractContents(),r.insertBefore(i,e),this.isInsideChange(e,!0)&&this._updateNodeTooltip(e.previousSibling),e.previousSibling},_triggerChange:function(){this._isTracking&&this.$this.trigger("change")},_triggerChangeText:function(){this.$this.trigger("textChange")},_updateNodeTooltip:function(e){this.tooltips&&this._isVisible&&this._addTooltip(e)},_acceptRejectSome:function(e,t){var n=function(e,n){this.acceptRejectChange(n,t)}.bind(this),i=this._filterChanges(e);for(var r in i.changes){var o=ice.dom.find(this.element,"["+this.attributes.changeId+"="+r+"]");o.each(n)}i.count&&this._triggerChange()},_filterChanges:function(e){var t=0,n={},i=e||{},r=i.filter,o=i.exclude?jQuery.map(i.exclude,function(e){return String(e)}):null,a=i.include?jQuery.map(i.include,function(e){return String(e)}):null,s=i.verify,d=null;for(var c in this._changes){var l=this._changes[c];if(l&&l.type){var u=r&&!r({userid:l.userid,time:l.time,data:l.data})||o&&o.indexOf(l.userid)>=0||a&&a.indexOf(l.userid)<0;u||(s&&(d=ice.dom.find(this.element,"["+this.attributes.changeId+"]"),u=!d.length),u||(++t,n[c]=l))}}return{count:t,changes:n}},_loadFromDom:function(){function e(e,o){for(var a=0,s="",d=o.className.split(" "),e=0;e<d.length;e++){var c=new RegExp(this.stylePrefix+"-(\\d+)").exec(d[e]);c&&(a=c[1]);var l=new RegExp("("+r.join("|")+")").exec(d[e]);l&&(s=this._getChangeTypeFromAlias(l[1]))}var u,h=ice.dom.attr(o,this.attributes.userId);t&&h==t?(u=n,o.setAttribute(this.attributes.userName,n)):u=o.getAttribute(this.attributes.userName),this._setUserStyle(h,Number(a));var f=parseInt(ice.dom.attr(o,this.attributes.changeId)||"");isNaN(f)&&(f=this.getNewChangeId(),o.setAttribute(this.attributes.changeId,f));var g=parseInt(o.getAttribute(this.attributes.time)||"");isNaN(g)&&(g=i);var m=parseInt(o.getAttribute(this.attributes.lastTime)||"");isNaN(m)&&(m=g);var p=o.getAttribute(this.attributes.sessionId),v=ice.dom.attr(o,this.attributes.changeData)||"",C={type:s,userid:String(h),username:u,time:g,lastTime:m,sessionId:p,data:v};this._changes[f]=C,this._updateNodeTooltip(o)}this._changes={},this._uniqueStyleIndex=0;var t=this.currentUser&&this.currentUser.id,n=this.currentUser&&this.currentUser.name||"",i=(new Date).getTime(),r=[];for(var o in this.changeTypes)r.push(this._getIceNodeClass(o));var a=this.getIceNodes();a.each(e.bind(this)),this._triggerChange()},_updateUserData:function(e){if(e)for(var t in this._changes){var n=this._changes[t];n.userid==e.id&&(n.username=e.name)}var i=this.getIceNodes();i.each(function(t,n){var i=!e||e.id==n.getAttribute(this.attributes.userId);e&&i&&n.setAttribute(this.attributes.userName,e.name)}.bind(this))},_showTitles:function(e){var t=this.getIceNodes();e?jQuery(t).each(function(e,t){this._updateNodeTooltip(t)}.bind(this)):jQuery(t).removeAttr("title")},_updateTooltipsState:function(){if(this.tooltips&&this._isVisible){if(!this._showingTips){this._showingTips=!0;var e=this.getIceNodes(),t=this;e.each(function(e,n){t._addTooltip(n)})}}else if(this._showingTips){this._showingTips=!1;var e=this.getIceNodes();e.each(function(e,t){jQuery(t).unbind("mouseover").unbind("mouseout")})}},_addTooltip:function(e){jQuery(e).unbind("mouseover").unbind("mouseout").mouseover(this._tooltipMouseOver).mouseout(this._tooltipMouseOut)},_tooltipMouseOver:function(e){var t=e.currentTarget,n=jQuery(t),i=this;if(!n.data("_tooltip_t")){var r=setTimeout(function(){var e=i.currentChangeNode(t),r=e&&e.getAttribute(i.attributes.changeId),o=r&&i.getChange(r);if(o){var a=ice.dom.hasClass(e,i._getIceNodeClass("insertType"))?"insert":"delete";n.removeData("_tooltip_t"),i.hostMethods.showTooltip(t,{userName:o.username,userId:o.userid,time:o.time,lastTime:o.lastTime,type:a})}},this.tooltipsDelay);n.data("_tooltip_t",r)}},_tooltipMouseOut:function(e){var t=e.currentTarget,n=jQuery(t),i=n.data("_tooltip_t");n.removeData("_tooltip_t"),i?clearTimeout(i):this.hostMethods.hideTooltip(t)},_removeTrackingInRange:function(e){var t=this._getIceNodeClass("insertType"),n=this._getIceNodeClass("deleteType"),i="."+t+",."+n,r="data-ice-class",o=function(e){var t=null,n=null;if(e.nodeType==ice.dom.TEXT_NODE)n=jQuery(e).parents(i);else{var o=jQuery(e);n=o.is(i)?o:o.parents(i)}if(t=n&&n[0]){var a=t.className;return t.setAttribute(r,a),t.setAttribute("class",""),!0}return!1};e.getNodes(null,o);var a=this.element;setTimeout(function(){var e=jQuery(a).find("["+r+"]");e.each(function(e,t){var n=t.getAttribute(r);n&&(t.setAttribute("class",n),t.removeAttribute(r))})},1)}};var s=window&&window.console||{log:function(){},error:function(){},info:function(){},assert:function(){},count:function(){}},d=null;a.ice=this.ice||{},this.ice.printRange=i,a.ice.InlineChangeEditor=o}.call(this),function(){function e(t,n){for(;t;){if(i.TEXT_NODE==t.nodeType)return t;for(var r=t.firstChild;r;r=r.nextSibling){var o=e(r,n);if(o)return o}if(i.isTextContainer(t))return t;t=t.nextSibling}return null}function t(e,n){for(;e;){if(i.TEXT_NODE==e.nodeType)return e;for(var r=e.lastChild;r;r=r.previousSibling){var o=t(r,n);if(o)return o}if(i.isTextContainer(e))return e;e=e.previousSibling}return null}var n=this,i={},r=null;i.DOM_VK_DELETE=8,i.DOM_VK_LEFT=37,i.DOM_VK_UP=38,i.DOM_VK_RIGHT=39,i.DOM_VK_DOWN=40,i.DOM_VK_ENTER=13,i.ELEMENT_NODE=1,i.ATTRIBUTE_NODE=2,i.TEXT_NODE=3,i.CDATA_SECTION_NODE=4,i.ENTITY_REFERENCE_NODE=5,i.ENTITY_NODE=6,i.PROCESSING_INSTRUCTION_NODE=7,i.COMMENT_NODE=8,i.DOCUMENT_NODE=9,i.DOCUMENT_TYPE_NODE=10,i.DOCUMENT_FRAGMENT_NODE=11,i.NOTATION_NODE=12,i.CHARACTER_UNIT="character",i.WORD_UNIT="word",i.BREAK_ELEMENT="br",i.CONTENT_STUB_ELEMENTS=["img","hr","iframe","param","link","meta","input","frame","col","base","area"],i.BLOCK_ELEMENTS=["body","p","div","pre","ul","ol","li","table","tbody","td","th","fieldset","form","blockquote","dl","dt","dd","dir","center","address","h1","h2","h3","h4","h5","h6"],i.TEXT_CONTAINER_ELEMENTS=["body","p","div","pre","span","b","strong","i","li","td","th","blockquote","dt","dd","center","address","h1","h2","h3","h4","h5","h6"],i.STUB_ELEMENTS=i.CONTENT_STUB_ELEMENTS.slice(),i.STUB_ELEMENTS.push(i.BREAK_ELEMENT),i.getKeyChar=function(e){return String.fromCharCode(e.which)},i.getClass=function(e,t,n){return t||(t=document.body),e="."+e.split(" ").join("."),n&&(e=n+e),jQuery.makeArray(jQuery(t).find(e))},i.getId=function(e,t){return t||(t=document),element=t.getElementById(e)},i.getTag=function(e,t){return t||(t=document),jQuery.makeArray(jQuery(t).find(e))},i.getElementWidth=function(e){return e.offsetWidth},i.getElementHeight=function(e){return e.offsetHeight},i.getElementDimensions=function(e){var t={width:i.getElementWidth(e),height:i.getElementHeight(e)};return t},i.trim=function(e){return jQuery.trim(e)},i.empty=function(e){return e?jQuery(e).empty():void 0},i.remove=function(e){return e?jQuery(e).remove():void 0},i.prepend=function(e,t){jQuery(e).prepend(t)},i.append=function(e,t){jQuery(e).append(t)},i.insertBefore=function(e,t){jQuery(e).before(t)},i.insertAfter=function(e,t){jQuery(e).after(t)},i.getHtml=function(e){return jQuery(e).html()},i.setHtml=function(e,t){e&&jQuery(e).html(t)},i.removeWhitespace=function(e){jQuery(e).contents().filter(function(){return this.nodeType!=ice.dom.TEXT_NODE&&"UL"==this.nodeName||"OL"==this.nodeName?(i.removeWhitespace(this),!1):this.nodeType!=ice.dom.TEXT_NODE?!1:!/\S/.test(this.nodeValue)}).remove()},i.contents=function(e){return jQuery.makeArray(jQuery(e).contents())},i.extractContent=function(e){for(var t,n=document.createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n},i.getNode=function(e,t){return e?(e=e.$||e,e.nodeType!=i.TEXT_NODE&&i.is(e,t)?e:i.parents(e,t)[0]||null):null},i.getParents=function(e,t,n){for(var i=jQuery(e).parents(t),r=i.length,o=[],a=0;r>a&&i[a]!==n;a++)o.push(i[a]);return o},i.hasBlockChildren=function(e){for(var t=e.childNodes.length,n=0;t>n;n++)if(e.childNodes[n].nodeType===i.ELEMENT_NODE&&i.isBlockElement(e.childNodes[n])===!0)return!0;return!1},i.removeTag=function(e,t){return jQuery(e).find(t).replaceWith(function(){return jQuery(this).contents()}),e},i.stripEnclosingTags=function(e,t){var n=jQuery(e);return n.find("*").not(t).replaceWith(function(){var e,t=jQuery();try{e=jQuery(this),t=e.contents()}catch(n){}return 0===t.length&&e.remove(),t}),n[0]},i.getSiblings=function(e,t,n,i){if(n===!0)return"prev"===t?jQuery(e).prevAll():jQuery(e).nextAll();var r=[];if("prev"===t)for(;e.previousSibling&&(e=e.previousSibling,e!==i);)r.push(e);else for(;e.nextSibling&&(e=e.nextSibling,e!==i);)r.push(e);return r},i.getNodeTextContent=function(e){return jQuery(e).text()},i.getNodeStubContent=function(e){return jQuery(e).find(i.CONTENT_STUB_ELEMENTS.join(", "))},i.hasNoTextOrStubContent=function(e){return i.getNodeTextContent(e).length>0?!1:jQuery(e).find(i.CONTENT_STUB_ELEMENTS.join(", ")).length>0?!1:!0},i.getNodeCharacterLength=function(e){return i.getNodeTextContent(e).length+jQuery(e).find(i.STUB_ELEMENTS.join(", ")).length},i.setNodeTextContent=function(e,t){return jQuery(e).text(t)},i.getTagName=function(e){return e.tagName&&e.tagName.toLowerCase()||null},i.getIframeDocument=function(e){var t=null;return e.contentDocument?t=e.contentDocument:e.contentWindow?t=e.contentWindow.document:e.document&&(t=e.document),t},i.isBlockElement=function(e){return-1!=i.BLOCK_ELEMENTS.indexOf(e.nodeName.toLowerCase())},i.isStubElement=function(e){return-1!=i.STUB_ELEMENTS.indexOf(e.nodeName.toLowerCase())},i.removeBRFromChild=function(e){if(e&&e.hasChildNodes())for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];n&&ice.dom.BREAK_ELEMENT==ice.dom.getTagName(n)&&n.parentNode.removeChild(n)}},i.isChildOf=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode===t)return!0;e=e.parentNode}}catch(n){}return!1},i.isChildOfTagName=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode&&e.parentNode.tagName&&e.parentNode.tagName.toLowerCase()===t)return e.parentNode;e=e.parentNode}}catch(n){}return!1},i.isChildOfTagNames=function(e,t){try{for(;e&&e.parentNode;){if(e.parentNode&&e.parentNode.tagName){tagName=e.parentNode.tagName.toLowerCase();for(var n=0;n<t.length;n++)if(tagName===t[n])return e.parentNode}e=e.parentNode}}catch(i){}return null},i.isChildOfClassName=function(e,t){try{for(;e&&e.parentNode;){if(jQuery(e.parentNode).hasClass(t))return e.parentNode;e=e.parentNode}}catch(n){}return null},i.cloneNode=function(e,t){return void 0===t&&(t=!0),jQuery(e).clone(t)},i.bind=function(e,t,n){return jQuery(e).bind(t,n)},i.unbind=function(e,t,n){return jQuery(e).unbind(t,n)},i.attr=function(e,t,n){return n?jQuery(e).attr(t,n):jQuery(e).attr(t)},i.replaceWith=function(e,t){return jQuery(e).replaceWith(t)},i.removeAttr=function(e,t){jQuery(e).removeAttr(t)},i.getElementsBetween=function(e,t){var n=[];if(e===t)return n;if(i.isChildOf(t,e)===!0){for(var r=e.childNodes.length,o=0;r>o&&e.childNodes[o]!==t;o++){if(i.isChildOf(t,e.childNodes[o])===!0)return i.arrayMerge(n,i.getElementsBetween(e.childNodes[o],t));n.push(e.childNodes[o])}return n}for(var a=e.nextSibling;a;){if(i.isChildOf(t,a)===!0)return n=i.arrayMerge(n,i.getElementsBetween(a,t));if(a===t)return n;n.push(a),a=a.nextSibling}for(var s=i.getParents(e),d=i.getParents(t),c=i.arrayDiff(s,d,!0),l=c.length,u=0;l-1>u;u++)n=i.arrayMerge(n,i.getSiblings(c[u],"next"));var h=c[c.length-1];return n=i.arrayMerge(n,i.getElementsBetween(h,t))},i.getCommonAncestor=function(e,t){for(var n=e;n;){if(i.isChildOf(t,n)===!0)return n;n=n.parentNode}return null},i.getNextNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.nextSibling){if(e.nextSibling.nodeType===i.TEXT_NODE&&0===e.nextSibling.length){e=e.nextSibling;continue}return i.getFirstChild(e.nextSibling)}e=e.parentNode}return null},i.getNextContentNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.nextSibling&&i.canContainTextElement(i.getBlockParent(e))){if(e.nextSibling.nodeType===i.TEXT_NODE&&0===e.nextSibling.length){e=e.nextSibling;continue}return e.nextSibling}if(e.nextElementSibling)return e.nextElementSibling;e=e.parentNode}return null},i.getPrevNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.previousSibling){if(e.previousSibling.nodeType===i.TEXT_NODE&&0===e.previousSibling.length){e=e.previousSibling;continue}return i.getLastChild(e.previousSibling)}e=e.parentNode}return null},i.getPrevContentNode=function(e,t){if(e)for(;e.parentNode;){if(e===t)return null;if(e.previousSibling&&i.canContainTextElement(i.getBlockParent(e))){if(e.previousSibling.nodeType===i.TEXT_NODE&&0===e.previousSibling.length){e=e.previousSibling;continue}return e.previousSibling}if(e.previousElementSibling)return e.previousElementSibling;e=e.parentNode}return null},i.findPrevTextContainer=function(e,n){if(!e||e==n)return{node:n,offset:0};if(e.parentNode&&i.isTextContainer(e.parentNode))return{node:e.parentNode,offset:i.getNodeIndex(e)};for(;e.previousSibling;){var r=t(e.previousSibling);if(r)return{node:r,offset:i.getNodeLength(r)};e=e.previousSibling}return i.findPrevTextContainer(e.parentNode&&e.parentNode.previousSibling,n)},i.findNextTextContainer=function(t,n){if(!t||t==n)return{node:n,offset:i.getNodeLength(n)};if(t.parentNode&&i.isTextContainer(t.parentNode))return{node:t.parentNode,offset:i.getNodeIndex(t)+1};for(;t.nextSibling;){var r=e(t.nextSibling);if(r)return{node:r,offset:0};t=t.previousSibling}return i.findNextTextContainer(t.parentNode&&t.parentNode.nextSibling,n)},i.getNodeLength=function(e){return e?i.TEXT_NODE==e.nodeType?e.length:e.childNodes&&e.childNodes.length||0:0},i.isTextContainer=function(e){return e&&i.TEXT_NODE==e.nodeType||i.TEXT_CONTAINER_ELEMENTS.indexOf((e.nodeName||"").toLowerCase())>=0},i.getNodeIndex=function(e){for(var t=0;e=e.previousSibling;)++t;return t},i.canContainTextElement=function(e){return e&&e.nodeName?-1!=i.TEXT_CONTAINER_ELEMENTS.lastIndexOf(e.nodeName.toLowerCase()):!1},i.getFirstChild=function(e){return e.firstChild?e.firstChild.nodeType===i.ELEMENT_NODE?i.getFirstChild(e.firstChild):e.firstChild:e},i.getLastChild=function(e){return e.lastChild?e.lastChild.nodeType===i.ELEMENT_NODE?i.getLastChild(e.lastChild):e.lastChild:e},i.removeEmptyNodes=function(e,t){for(var n=jQuery(e).find(":empty"),r=n.length;r>0;)r--,i.isStubElement(n[r])===!1&&(t&&t.call(this,n[r])===!1||i.remove(n[r]))},i.create=function(e){return jQuery(e)[0]},i.find=function(e,t){return jQuery(e).find(t)},i.children=function(e,t){return jQuery(e).children(t)},i.parent=function(e,t){return jQuery(e).parent(t)[0]},i.parents=function(e,t){return jQuery(e).parents(t)},i.is=function(e,t){return jQuery(e).is(t)},i.extend=function(){return jQuery.extend.apply(this,arguments)},i.walk=function(e,t,n){if(e){n||(n=0);var r=t.call(this,e,n);r!==!1&&(e.childNodes&&e.childNodes.length>0?i.walk(e.firstChild,t,n+1):e.nextSibling?i.walk(e.nextSibling,t,n):e.parentNode&&e.parentNode.nextSibling&&i.walk(e.parentNode.nextSibling,t,n-1))}},i.revWalk=function(e,t){if(e){var n=t.call(this,e);n!==!1&&(e.childNodes&&e.childNodes.length>0?i.walk(e.lastChild,t):e.previousSibling?i.walk(e.previousSibling,t):e.parentNode&&e.parentNode.previousSibling&&i.walk(e.parentNode.previousSibling,t))}},i.setStyle=function(e,t,n){e&&jQuery(e).css(t,n)},i.getStyle=function(e,t){return jQuery(e).css(t)},i.hasClass=function(e,t){return jQuery(e).hasClass(t)},i.addClass=function(e,t){jQuery(e).addClass(t)},i.removeClass=function(e,t){jQuery(e).removeClass(t)},i.preventDefault=function(e){e.preventDefault(),i.stopPropagation(e)},i.stopPropagation=function(e){e.stopPropagation()},i.noInclusionInherits=function(e,t){(t instanceof String||"string"==typeof t)&&(t=window[t]),(e instanceof String||"string"==typeof e)&&(e=window[e]);var n=function(){};if(i.isset(t)===!0)for(value in t.prototype)e.prototype[value]?n.prototype[value]=t.prototype[value]:e.prototype[value]=t.prototype[value];e.prototype&&(n.prototype.constructor=t,e.prototype["super"]=new n)},i.each=function(e,t){jQuery.each(e,function(e,n){t.call(this,e,n)})},i.foreach=function(e,t){if(e instanceof Array||e instanceof NodeList||"undefined"!=typeof e.length&&"undefined"!=typeof e.item)for(var n=e.length,i=0;n>i;i++){var r=t.call(this,i,e[i]);if(r===!1)break}else for(var o in e)if(e.hasOwnProperty(o)===!0){var r=t.call(this,o);if(r===!1)break}},i.isBlank=function(e){return!e||/^\s*$/.test(e)?!0:!1},i.isFn=function(e){return"function"==typeof e?!0:!1},i.isObj=function(e){return null!==e&&"object"==typeof e?!0:!1},i.isset=function(e){return"undefined"!=typeof e&&null!==e?!0:!1},i.isArray=function(e){return jQuery.isArray(e)},i.isNumeric=function(e){var t=e.match(/^\d+$/);return null!==t?!0:!1},i.getUniqueId=function(){var e=(new Date).getTime(),t=Math.ceil(1e6*Math.random()),n=e+""+t;return n.substr(5,18).replace(/,/,"")},i.inArray=function(e,t){for(var n=t.length,i=0;n>i;i++)if(e===t[i])return!0;return!1},i.arrayDiff=function(e,t,n){for(var r=e.length,o=[],a=0;r>a;a++)i.inArray(e[a],t)===!1&&o.push(e[a]);if(n!==!0){r=t.length;for(var a=0;r>a;a++)i.inArray(t[a],e)===!1&&o.push(t[a])}return o},i.arrayMerge=function(e,t){for(var n=t.length,i=0;n>i;i++)e.push(t[i]);return e},i.stripTags=function(e,t){if("string"==typeof t){var n=jQuery("<div>"+e+"</div>");return n.find("*").not(t).remove(),n.html()}for(var r,o=new RegExp(/<\/?(\w+)((\s+\w+(\s*=\s*(?:".*?"|'.*?'|[^'">\s]+))?)+\s*|\s*)\/?>/gim),a=e;null!=(r=o.exec(e));)(i.isset(t)===!1||i.inArray(r[1],t)!==!0)&&(a=a.replace(r[0],""));return a},i.browser=function(){return r?jQuery.extend({},r):(r=function(){function e(e){e=e.toLowerCase();var t=/(chrome)[ \/]([\w.]+)/.exec(e)||/(webkit)[ \/]([\w.]+)/.exec(e)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e)||/(msie) ([\w.]+)/.exec(e)||e.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e)||[];return{browser:t[1]||"",version:t[2]||"0"}}var t=navigator.userAgent.toLowerCase(),n=e(t),i={type:"unknown",version:0,msie:!1};return n.browser&&(i[n.browser]=!0,i.version=n.version||0,i.type=n.browser),i.chrome?i.webkit=!0:i.webkit&&(i.safari=!0),i.webkit&&(i.type="webkit"),i.firefox=1==/firefox/.test(t),i.msie||(i.msie=!!/trident/.test(t)),i}(),jQuery.extend({},r))},i.getBrowserType=function(){if(null===this._browserType){for(var e=["msie","firefox","chrome","safari"],t=e.length,n=0;t>n;n++){var i=new RegExp(e[n],"i");if(i.test(navigator.userAgent)===!0)return this._browserType=e[n],this._browserType}this._browserType="other"}return this._browserType},i.getWebkitType=function(){if("webkit"!==i.browser().type)return console.log("Not a webkit!"),!1;var e=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0;
return e?"safari":"chrome"},i.isBrowser=function(e){return i.browser().type===e},i.getBlockParent=function(e,t){if(i.isBlockElement(e)===!0)return e;if(e)for(;e.parentNode;){if(e=e.parentNode,i.isBlockElement(e)===!0)return e;if(e===t)return null}return null},i.findNodeParent=function(e,t,n){if(e)for(;e.parentNode;){if(e===n)return null;if(i.is(e,t)===!0)return e;e=e.parentNode}return null},i.onBlockBoundary=function(e,t,n){if(!e||!t)return!1;var r=i.isChildOfTagNames(e,n)||i.is(e,n.join(", "))&&e||null,o=i.isChildOfTagNames(t,n)||i.is(t,n.join(", "))&&t||null;return r!==o},i.isOnBlockBoundary=function(e,t,n){if(!e||!t)return!1;var r=i.getBlockParent(e,n)||i.isBlockElement(e,n)&&e||null,o=i.getBlockParent(t,n)||i.isBlockElement(t,n)&&t||null;return r!==o},i.mergeContainers=function(e,t){if(!e||!t)return!1;if(e.nodeType===i.TEXT_NODE||i.isStubElement(e))t.appendChild(e);else if(e.nodeType===i.ELEMENT_NODE){for(;e.firstChild;)t.appendChild(e.firstChild);i.remove(e)}return!0},i.mergeBlockWithSibling=function(e,t,n){var r=n?jQuery(t).next().get(0):jQuery(t).prev().get(0);return n?i.mergeContainers(r,t):i.mergeContainers(t,r),e.collapse(!0),!0},i.date=function(e,t,n){if(null!==t||!n||(t=i.tsIso8601ToTimestamp(n))){for(var r=new Date(t),o=e.split(""),a=o.length,s="",d=0;a>d;d++){var c="",l=o[d];switch(l){case"D":case"l":var u=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];c=u[r.getDay()],"D"===l&&(c=c.substring(0,3));break;case"F":case"m":c=r.getMonth()+1,10>c&&(c="0"+c);break;case"M":months=["January","February","March","April","May","June","July","August","September","October","November","December"],c=months[r.getMonth()],"M"===l&&(c=c.substring(0,3));break;case"d":c=r.getDate();break;case"S":c=i.getOrdinalSuffix(r.getDate());break;case"Y":c=r.getFullYear();break;case"y":c=r.getFullYear(),c=c.toString().substring(2);break;case"H":c=r.getHours();break;case"h":c=r.getHours(),0===c?c=12:c>12&&(c-=12);break;case"i":c=i.addNumberPadding(r.getMinutes());break;case"a":c="am",r.getHours()>=12&&(c="pm");break;default:c=l}s+=c}return s}},i.getOrdinalSuffix=function(e){var t="",n=e%100;if(n>=4&&20>=n)t="th";else switch(e%10){case 1:t="st";break;case 2:t="nd";break;case 3:t="rd";break;default:t="th"}return t},i.addNumberPadding=function(e){return 10>e&&(e="0"+e),e},i.tsIso8601ToTimestamp=function(e){var t=/(\d\d\d\d)(?:-?(\d\d)(?:-?(\d\d)(?:[T ](\d\d)(?::?(\d\d)(?::?(\d\d)(?:\.(\d+))?)?)?(?:Z|(?:([-+])(\d\d)(?::?(\d\d))?)?)?)?)?)?/,n=e.match(new RegExp(t));if(n){var i=new Date;i.setDate(n[3]),i.setFullYear(n[1]),i.setMonth(n[2]-1),i.setHours(n[4]),i.setMinutes(n[5]),i.setSeconds(n[6]);var r=60*n[9];"+"===n[8]&&(r*=-1),r-=i.getTimezoneOffset();var o=i.getTime()+60*r*1e3;return o}return null},i.normalizeNode=function(e){return e?"function"==typeof e.normalize?e.normalize():this._myNormalizeNode(e):void 0},n.dom=i}.call(this.ice),function(){var e,t=this;e=function(e){this._selection=null,this.env=e,this._initializeRangeLibrary(),this._getSelection()},e.prototype={_getSelection:function(){return this._selection?this._selection.refresh():this._selection=this.env.frame?rangy.getSelection(this.env.frame):rangy.getSelection(),this._selection},createRange:function(){return rangy.createRange(this.env.document)},getRangeAt:function(e){var t=null;try{this._selection.refresh(),t=this._selection.getRangeAt(e)}catch(n){this._selection=null,t=this._getSelection().getRangeAt(0)}return t},addRange:function(e){this._selection||(this._selection=this._getSelection()),this._selection.setSingleRange(e),this._selection.ranges=[e]},_initializeRangeLibrary:function(){var e=this;rangy.init(),rangy.config.checkSelectionRanges=!1;var t=function(e,t,n,i){if(0!==n)switch(t){case ice.dom.CHARACTER_UNIT:n>0?e.moveCharRight(i,n):e.moveCharLeft(i,-1*n);break;case ice.dom.WORD_UNIT:}};rangy.rangePrototype.moveStart=function(e,n){t(this,e,n,!0)},rangy.rangePrototype.moveEnd=function(e,n){t(this,e,n,!1)},rangy.rangePrototype.setRange=function(e,t,n){e?this.setStart(t,n):this.setEnd(t,n)},rangy.rangePrototype.moveCharLeft=function(e,t){var n,i;if(e?(n=this.startContainer,i=this.startOffset):(n=this.endContainer,i=this.endOffset),n.nodeType===ice.dom.ELEMENT_NODE)if(n.hasChildNodes()){for(n=n.childNodes[i],n=this.getPreviousTextNode(n);n&&n.nodeType==ice.dom.TEXT_NODE&&""===n.nodeValue;)n=this.getPreviousTextNode(n);i=n.data.length-t}else i=-1*t;else i-=t;if(0>i)for(;0>i;){var r=[];if(n=this.getPreviousTextNode(n,r),!n)return;n.nodeType!==ice.dom.ELEMENT_NODE&&(i+=n.data.length)}this.setRange(e,n,i)},rangy.rangePrototype.moveCharRight=function(e,t){var n,i;e?(n=this.startContainer,i=this.startOffset):(n=this.endContainer,i=this.endOffset),n.nodeType===ice.dom.ELEMENT_NODE?(n=n.childNodes[i],n.nodeType!==ice.dom.TEXT_NODE&&(n=this.getNextTextNode(n)),i=t):i+=t;var r=i-n.data.length;if(r>0){for(var o=[];r>0;){if(n=this.getNextContainer(n,o),!n)return;if(n.nodeType!==ice.dom.ELEMENT_NODE){if(n.data.length>=r)break;n.data.length>0&&(r-=n.data.length)}}i=r}this.setRange(e,n,i)},rangy.rangePrototype.getNextContainer=function(e,t){if(!e)return null;for(;e.nextSibling;)if(e=e.nextSibling,e.nodeType!==ice.dom.TEXT_NODE){var n=this.getFirstSelectableChild(e);if(null!==n)return n}else if(this.isSelectable(e)===!0)return e;for(;e&&!e.nextSibling;)e=e.parentNode;if(!e)return null;if(e=e.nextSibling,this.isSelectable(e)===!0)return e;t&&ice.dom.isBlockElement(e)===!0&&t.push(e);var i=this.getFirstSelectableChild(e);return null!==i?i:this.getNextContainer(e,t)},rangy.rangePrototype.getPreviousContainer=function(e,t){if(!e)return null;for(;e.previousSibling;)if(e=e.previousSibling,e.nodeType!==ice.dom.TEXT_NODE){if(ice.dom.isStubElement(e)===!0)return e;var n=this.getLastSelectableChild(e);if(null!==n)return n}else if(this.isSelectable(e)===!0)return e;for(;e&&!e.previousSibling;)e=e.parentNode;if(!e)return null;if(e=e.previousSibling,this.isSelectable(e)===!0)return e;t&&ice.dom.isBlockElement(e)===!0&&t.push(e);var i=this.getLastSelectableChild(e);return null!==i?i:this.getPreviousContainer(e,t)},rangy.rangePrototype.getNextTextNode=function(e){return e.nodeType===ice.dom.ELEMENT_NODE&&0!==e.childNodes.length?this.getFirstSelectableChild(e):(e=this.getNextContainer(e),e.nodeType===ice.dom.TEXT_NODE?e:this.getNextTextNode(e))},rangy.rangePrototype.getPreviousTextNode=function(e,t){return e=this.getPreviousContainer(e,t),e.nodeType===ice.dom.TEXT_NODE?e:this.getPreviousTextNode(e,t)},rangy.rangePrototype.getFirstSelectableChild=function(e){if(e){if(e.nodeType===ice.dom.TEXT_NODE)return e;for(var t=e.firstChild;t;){if(this.isSelectable(t)===!0)return t;if(t.firstChild){var n=this.getFirstSelectableChild(t);if(null!==n)return n;t=t.nextSibling}else t=t.nextSibling}}return null},rangy.rangePrototype.getLastSelectableChild=function(e){if(e){if(e.nodeType===ice.dom.TEXT_NODE)return e;for(var t=e.lastChild;t;){if(this.isSelectable(t)===!0)return t;if(t.lastChild){var n=this.getLastSelectableChild(t);if(null!==n)return n;t=t.previousSibling}else t=t.previousSibling}}return null},rangy.rangePrototype.isSelectable=function(e){return e&&e.nodeType===ice.dom.TEXT_NODE&&0!==e.data.length?!0:!1},rangy.rangePrototype.getHTMLContents=function(t){t||(t=this.cloneContents());var n=e.env.document.createElement("div");return n.appendChild(t.cloneNode(!0)),n.innerHTML},rangy.rangePrototype.getHTMLContentsObj=function(){return this.cloneContents()}}},t.Selection=e}.call(this.ice),function(){var e,t=this;e=function(e,t,n){this.env=e,this.element=e.element,this.selection=this.env.selection,n||this.removeBookmarks(this.element);{var i,r=t||this.selection.getRangeAt(0),t=r.cloneRange(),o=t.startContainer,a=t.startOffset;t.endOffset}t.collapse(!1);var s=this.env.document.createElement("span");s.style.display="none",ice.dom.setHtml(s,"&nbsp;"),ice.dom.addClass(s,"iceBookmark iceBookmark_end"),s.setAttribute("iceBookmark","end"),t.insertNode(s),ice.dom.isChildOf(s,this.element)||this.element.appendChild(s),t.setStart(o,a),t.collapse(!0);var d=this.env.document.createElement("span");d.style.display="none",ice.dom.addClass(d,"iceBookmark iceBookmark_start"),ice.dom.setHtml(d,"&nbsp;"),d.setAttribute("iceBookmark","start");try{t.insertNode(d),d.previousSibling===s&&(i=d,d=s,s=i)}catch(c){ice.dom.insertBefore(s,d)}ice.dom.isChildOf(d,this.element)===!1&&(this.element.firstChild?ice.dom.insertBefore(this.element.firstChild,d):this.element.appendChild(d)),s.previousSibling||(i=this.env.document.createTextNode(""),ice.dom.insertBefore(s,i)),d.nextSibling||(i=this.env.document.createTextNode(""),ice.dom.insertAfter(d,i)),r.setStart(d.nextSibling,0),r.setEnd(s.previousSibling,s.previousSibling.length||0),this.start=d,this.end=s},e.prototype={selectBookmark:function(){var e=this.selection.getRangeAt(0),t=null,n=null,i=0,r=null,o=this.start&&this.start.parentNode;if(this.start.nextSibling===this.end||0===ice.dom.getElementsBetween(this.start,this.end).length)this.end.nextSibling?t=ice.dom.getFirstChild(this.end.nextSibling):this.start.previousSibling?(t=ice.dom.getFirstChild(this.start.previousSibling),t.nodeType===ice.dom.TEXT_NODE&&(i=t.length)):(this.end.parentNode.appendChild(this.env.document.createTextNode("")),t=ice.dom.getFirstChild(this.end.nextSibling));else{if(this.start.nextSibling)t=ice.dom.getFirstChild(this.start.nextSibling);else{if(!this.start.previousSibling){var a=this.env.document.createTextNode("");ice.dom.insertBefore(this.start,a)}t=ice.dom.getLastChild(this.start.previousSibling),i=t.length}this.end.previousSibling?n=ice.dom.getLastChild(this.end.previousSibling):(n=ice.dom.getFirstChild(this.end.nextSibling||this.end),r=0)}ice.dom.remove([this.start,this.end]);try{ice.dom.normalize(o)}catch(s){}null===n?(e.setEnd(t,i),e.collapse(!1)):(e.setStart(t,i),null===r&&(r=n.length||0),e.setEnd(n,r));try{this.selection.addRange(e)}catch(s){}},getBookmark:function(e,t){var n=ice.dom.getClass("iceBookmark_"+t,e)[0];return n},removeBookmarks:function(e){ice.dom.remove(ice.dom.getClass("iceBookmark",e,"span"))}},t.Bookmark=e}.call(this.ice);var LITE={Events:{INIT:"lite:init",ACCEPT:"lite:accept",REJECT:"lite:reject",SHOW_HIDE:"lite:showHide",TRACKING:"lite:tracking",CHANGE:"lite:change"},Commands:{TOGGLE_TRACKING:"lite.ToggleTracking",TOGGLE_SHOW:"lite.ToggleShow",ACCEPT_ALL:"lite.AcceptAll",REJECT_ALL:"lite.RejectAll",ACCEPT_ONE:"lite.AcceptOne",REJECT_ONE:"lite.RejectOne",TOGGLE_TOOLTIPS:"lite.ToggleTooltips"}};